import * as tslib_1 from "tslib";
import { AfterViewInit, ChangeDetectorRef, Component, ElementRef, EventEmitter, Input, OnInit, Optional, Output, SimpleChanges, ViewChild } from '@angular/core';
import { ControlContainer } from '@angular/forms';
import { MatAutocompleteTrigger } from '@angular/material';
import { LuxFormComponentBase } from '../lux-form-model/lux-form-component-base.class';
import { debounceTime, distinctUntilChanged, map, startWith } from 'rxjs/operators';
import { ReplaySubject } from 'rxjs';
import { LuxConsoleService } from '../../lux-util/lux-console.service';
import { LuxComponentsConfigService } from '../../lux-components-config/lux-components-config.service';
var LuxAutocompleteComponent = /** @class */ (function (_super) {
    tslib_1.__extends(LuxAutocompleteComponent, _super);
    function LuxAutocompleteComponent(controlContainer, cdr, logger, config) {
        var _this = _super.call(this, controlContainer, cdr, logger, config) || this;
        _this.config = config;
        _this.selected$ = new ReplaySubject(1);
        _this.luxPlaceholder = '';
        _this.luxOptions = [];
        _this.luxOptionLabelProp = 'label';
        _this.luxLookupDelay = 500;
        _this.luxErrorMessageNotAnOption = 'Der eingegebene Wert ist nicht Teil der Auswahl.';
        _this.luxSelectAllOnClick = true;
        _this.luxStrict = true;
        _this.luxValueChange = new EventEmitter();
        _this.luxOptionSelected = new EventEmitter();
        _this.luxBlur = new EventEmitter();
        _this.luxFocus = new EventEmitter();
        return _this;
    }
    Object.defineProperty(LuxAutocompleteComponent.prototype, "luxValue", {
        get: function () {
            return this.getValue();
        },
        set: function (value) {
            this.setValue(value);
        },
        enumerable: true,
        configurable: true
    });
    LuxAutocompleteComponent.prototype.ngOnInit = function () {
        var _this = this;
        _super.prototype.ngOnInit.call(this);
        this.selected$.pipe(distinctUntilChanged()).subscribe(function (value) {
            if (_this.luxStrict) {
                if (value === '') {
                    _this.luxOptionSelected.emit(null);
                    _this.luxValueChange.emit(null);
                }
                else {
                    var selectedOption = _this.luxOptions.find(function (option) { return value === option; });
                    if (selectedOption) {
                        _this.luxOptionSelected.emit(selectedOption);
                        _this.luxValueChange.emit(selectedOption);
                    }
                }
            }
            else {
                _this.luxOptionSelected.emit(value);
                _this.luxValueChange.emit(value);
            }
        });
    };
    LuxAutocompleteComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        this.matAutoComplete.panelClosingActions
            .pipe(debounceTime(this.luxLookupDelay))
            .subscribe(function (value) {
            if (_this.luxStrict) {
                var filterResult = _this.filter(_this.getOptionLabel(_this.luxValue));
                if (filterResult.length === 1) {
                    _this.formControl.setValue(filterResult[0]);
                }
                _this.handleErrors();
            }
        });
        this.filteredOptions = this.formControl.valueChanges.pipe(startWith(''), debounceTime(this.luxLookupDelay), map(function (value) { return _this.getOptionLabel(value); }), map(function () {
            var filterLabel = _this.getOptionLabel(_this.luxValue);
            return filterLabel ? _this.filter(filterLabel) : _this.luxOptions;
        }));
    };
    /**
     * @override errorMessageModifier - Modifikation der Fehlermeldung
     * @param value
     * @param errors
     */
    LuxAutocompleteComponent.prototype.errorMessageModifier = function (value, errors) {
        if (errors['incorrect']) {
            return this.luxErrorMessageNotAnOption;
        }
        return undefined;
    };
    /**
     * Regelt die Darstellung der gewaehlten Option im Normalfall.
     * (Ausnahme: Focus-Verlust)
     * @param option
     * @returns string
     */
    LuxAutocompleteComponent.prototype.displayFn = function (option) {
        return this.getOptionLabel(this.luxValue);
    };
    /**
     * Filtert das Options-Array nach dem filterTerm und
     * gibt das Ergebnis als Array zurueck.
     * @param filterTerm
     * @returns any[]
     */
    LuxAutocompleteComponent.prototype.filter = function (filterTerm) {
        var _this = this;
        return this.luxOptions.filter(function (option) {
            var compareValue = _this.getOptionLabel(option);
            return (compareValue
                .trim()
                .toLowerCase()
                .indexOf(filterTerm.trim().toLowerCase()) > -1);
        });
    };
    /**
     * Click-Event Handling
     * Selektiert den gesamten Text im Input, wenn selectAllOnClick = true ist.
     * @param clickEvent
     */
    LuxAutocompleteComponent.prototype.onClick = function (clickEvent) {
        if (this.luxSelectAllOnClick) {
            clickEvent.target.setSelectionRange(0, clickEvent.target.value.length);
        }
    };
    /**
     * Gibt den darzustellenden Wert einer Option bzw.
     * die Option selbst (wenn string) wider.
     * @param option
     * @returns any
     */
    LuxAutocompleteComponent.prototype.getOptionLabel = function (option) {
        if (typeof option === 'string') {
            return option;
        }
        else if (!option) {
            return '';
        }
        else {
            return option[this.luxOptionLabelProp];
        }
    };
    LuxAutocompleteComponent.prototype.selected = function ($event) {
        this.luxValue = $event.option.value;
    };
    LuxAutocompleteComponent.prototype.handleErrors = function () {
        var errors = this.formControl ? this.formControl.errors : null;
        if (this.luxOptions.indexOf(this.luxValue) > -1 ||
            (!!errors && Object.keys(errors).length > 0 && errors['required'])) {
            this.handleOtherErrors(errors);
        }
        else {
            this.handleIncorrectError(errors);
        }
    };
    LuxAutocompleteComponent.prototype.handleOtherErrors = function (errors) {
        if (errors && errors['incorrect']) {
            delete errors['incorrect'];
        }
        this.formControl.setErrors(errors && Object.keys(errors).length !== 0 ? errors : null);
    };
    LuxAutocompleteComponent.prototype.handleIncorrectError = function (errors) {
        if (this.luxStrict && this.luxValue) {
            errors = errors ? errors : {};
            if (!errors['incorrect']) {
                errors['incorrect'] = true;
            }
            this.formControl.setErrors(errors);
        }
    };
    // region overridden methods
    LuxAutocompleteComponent.prototype.notifyFormValueChanged = function (formValue) {
        this.selected$.next(formValue);
        this.luxValueChange.emit(formValue);
        if (formValue && formValue[this.luxOptionLabelProp]) {
            this.matInput.nativeElement.value = formValue[this.luxOptionLabelProp];
        }
    };
    LuxAutocompleteComponent.prototype.triggerOutputPatternCheck = function () {
        this.checkOutputPatternViolation(this.luxValueChange.observers);
    };
    LuxAutocompleteComponent.prototype.triggerInputPatternCheck = function (simpleChanges) {
        this.checkInputPatternViolation(simpleChanges.luxValue);
    };
    LuxAutocompleteComponent.ctorParameters = function () { return [
        { type: ControlContainer, decorators: [{ type: Optional }] },
        { type: ChangeDetectorRef },
        { type: LuxConsoleService },
        { type: LuxComponentsConfigService }
    ]; };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], LuxAutocompleteComponent.prototype, "luxPlaceholder", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], LuxAutocompleteComponent.prototype, "luxReadonly", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Array)
    ], LuxAutocompleteComponent.prototype, "luxOptions", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], LuxAutocompleteComponent.prototype, "luxOptionLabelProp", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Number)
    ], LuxAutocompleteComponent.prototype, "luxLookupDelay", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], LuxAutocompleteComponent.prototype, "luxErrorMessageNotAnOption", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], LuxAutocompleteComponent.prototype, "luxTagId", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], LuxAutocompleteComponent.prototype, "luxSelectAllOnClick", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Boolean)
    ], LuxAutocompleteComponent.prototype, "luxStrict", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", EventEmitter)
    ], LuxAutocompleteComponent.prototype, "luxValueChange", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", EventEmitter)
    ], LuxAutocompleteComponent.prototype, "luxOptionSelected", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", EventEmitter)
    ], LuxAutocompleteComponent.prototype, "luxBlur", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", EventEmitter)
    ], LuxAutocompleteComponent.prototype, "luxFocus", void 0);
    tslib_1.__decorate([
        ViewChild('autoCompleteInput', { read: MatAutocompleteTrigger, static: false }),
        tslib_1.__metadata("design:type", MatAutocompleteTrigger)
    ], LuxAutocompleteComponent.prototype, "matAutoComplete", void 0);
    tslib_1.__decorate([
        ViewChild('autoCompleteInput', { read: ElementRef, static: false }),
        tslib_1.__metadata("design:type", ElementRef)
    ], LuxAutocompleteComponent.prototype, "matInput", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], LuxAutocompleteComponent.prototype, "luxValue", null);
    LuxAutocompleteComponent = tslib_1.__decorate([
        Component({
            selector: 'lux-autocomplete',
            template: "<lux-form-control [luxFormComponent]=\"this\" [formGroup]=\"formGroup\" *ngIf=\"formGroup\">\n  <div class=\"lux-input-row\">\n    <input\n      type=\"text\"\n      matInput\n      autocomplete=\"off\"\n      luxTagIdHandler\n      [luxTagId]=\"luxTagId\"\n      [formControl]=\"formControl\"\n      [placeholder]=\"luxPlaceholder\"\n      [matAutocomplete]=\"auto\"\n      [required]=\"luxRequired\"\n      (click)=\"onClick($event)\"\n      (blur)=\"luxBlur.emit($event)\"\n      (focus)=\"luxFocus.emit($event)\"\n      (focusin)=\"luxFocusIn.emit($event)\"\n      (focusout)=\"luxFocusOut.emit($event)\"\n      [id]=\"uid\"\n      [luxAriaDescribedby]=\"uid + '-error ' + uid + '-hint'\"\n      #autoCompleteInput\n    />\n    <mat-autocomplete\n      #auto=\"matAutocomplete\"\n      [class]=\"'lux-autocomplete-panel'\"\n      [displayWith]=\"displayFn.bind(this)\"\n      (optionSelected)=\"selected($event)\"\n    >\n      <mat-option *ngFor=\"let option of filteredOptions | async\" [value]=\"option\">\n        <ng-container *ngTemplateOutlet=\"optionTemplate; context: { $implicit: option }\"></ng-container>\n      </mat-option>\n    </mat-autocomplete>\n  </div>\n</lux-form-control>\n\n<ng-template #optionTemplate let-option>\n  <ng-container *ngIf=\"option[luxOptionLabelProp]; else showObjectTemplate\">\n    {{ option | luxRenderProperty: luxOptionLabelProp }}\n  </ng-container>\n  <ng-template #showObjectTemplate>\n    {{ option }}\n  </ng-template>\n</ng-template>\n",
            styles: ["::ng-deep .lux-autocomplete-panel mat-option:not(:last-of-type){margin-bottom:2px}"]
        }),
        tslib_1.__param(0, Optional()),
        tslib_1.__metadata("design:paramtypes", [ControlContainer,
            ChangeDetectorRef,
            LuxConsoleService,
            LuxComponentsConfigService])
    ], LuxAutocompleteComponent);
    return LuxAutocompleteComponent;
}(LuxFormComponentBase));
export { LuxAutocompleteComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHV4LWF1dG9jb21wbGV0ZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaWhrLWdmaS9sdXgtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbW9kdWxlcy9sdXgtZm9ybS9sdXgtYXV0b2NvbXBsZXRlL2x1eC1hdXRvY29tcGxldGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsYUFBYSxFQUNiLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUNOLFFBQVEsRUFDUixNQUFNLEVBQ04sYUFBYSxFQUNiLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNsRCxPQUFPLEVBQWdDLHNCQUFzQixFQUE0QixNQUFNLG1CQUFtQixDQUFDO0FBQ25ILE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxZQUFZLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3BGLE9BQU8sRUFBYyxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDdkUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sMkRBQTJELENBQUM7QUFPdkc7SUFBOEMsb0RBQW9CO0lBZ0NoRSxrQ0FDYyxnQkFBa0MsRUFDOUMsR0FBc0IsRUFDdEIsTUFBeUIsRUFDZixNQUFrQztRQUo5QyxZQU1FLGtCQUFNLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLFNBQzdDO1FBSFcsWUFBTSxHQUFOLE1BQU0sQ0FBNEI7UUFuQ3RDLGVBQVMsR0FBdUIsSUFBSSxhQUFhLENBQU0sQ0FBQyxDQUFDLENBQUM7UUFJekQsb0JBQWMsR0FBVyxFQUFFLENBQUM7UUFFNUIsZ0JBQVUsR0FBVSxFQUFFLENBQUM7UUFDdkIsd0JBQWtCLEdBQVcsT0FBTyxDQUFDO1FBQ3JDLG9CQUFjLEdBQVcsR0FBRyxDQUFDO1FBQzdCLGdDQUEwQixHQUFXLGtEQUFrRCxDQUFDO1FBRXhGLHlCQUFtQixHQUFZLElBQUksQ0FBQztRQUNwQyxlQUFTLEdBQVksSUFBSSxDQUFDO1FBRXpCLG9CQUFjLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdkQsdUJBQWlCLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDMUQsYUFBTyxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBQ3JELGNBQVEsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQzs7SUFxQmhFLENBQUM7SUFmRCxzQkFBSSw4Q0FBUTthQUFaO1lBQ0UsT0FBTyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDekIsQ0FBQzthQUVRLFVBQWEsS0FBVTtZQUM5QixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3ZCLENBQUM7OztPQUpBO0lBZUQsMkNBQVEsR0FBUjtRQUFBLGlCQW9CQztRQW5CQyxpQkFBTSxRQUFRLFdBQUUsQ0FBQztRQUVqQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLFVBQUEsS0FBSztZQUN6RCxJQUFJLEtBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2xCLElBQUksS0FBSyxLQUFLLEVBQUUsRUFBRTtvQkFDaEIsS0FBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDbEMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ2hDO3FCQUFNO29CQUNMLElBQU0sY0FBYyxHQUFHLEtBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFVBQUEsTUFBTSxJQUFJLE9BQUEsS0FBSyxLQUFLLE1BQU0sRUFBaEIsQ0FBZ0IsQ0FBQyxDQUFDO29CQUN4RSxJQUFJLGNBQWMsRUFBRTt3QkFDbEIsS0FBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQzt3QkFDNUMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7cUJBQzFDO2lCQUNGO2FBQ0Y7aUJBQU07Z0JBQ0wsS0FBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbkMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDakM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxrREFBZSxHQUFmO1FBQUEsaUJBd0JDO1FBdkJDLElBQUksQ0FBQyxlQUFlLENBQUMsbUJBQW1CO2FBQ3JDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO2FBQ3ZDLFNBQVMsQ0FBQyxVQUFDLEtBQStCO1lBQ3pDLElBQUksS0FBSSxDQUFDLFNBQVMsRUFBRTtnQkFDbEIsSUFBTSxZQUFZLEdBQUcsS0FBSSxDQUFDLE1BQU0sQ0FBQyxLQUFJLENBQUMsY0FBYyxDQUFDLEtBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUVyRSxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUM3QixLQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDNUM7Z0JBRUQsS0FBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQ3JCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFTCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLElBQUksQ0FDdkQsU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUNiLFlBQVksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQ2pDLEdBQUcsQ0FBQyxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEVBQTFCLENBQTBCLENBQUMsRUFDeEMsR0FBRyxDQUFDO1lBQ0YsSUFBTSxXQUFXLEdBQUcsS0FBSSxDQUFDLGNBQWMsQ0FBQyxLQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdkQsT0FBTyxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUksQ0FBQyxVQUFVLENBQUM7UUFDbEUsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsdURBQW9CLEdBQXBCLFVBQXFCLEtBQUssRUFBRSxNQUFNO1FBQ2hDLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ3ZCLE9BQU8sSUFBSSxDQUFDLDBCQUEwQixDQUFDO1NBQ3hDO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsNENBQVMsR0FBVCxVQUFVLE1BQVc7UUFDbkIsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCx5Q0FBTSxHQUFOLFVBQU8sVUFBZTtRQUF0QixpQkFVQztRQVRDLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsVUFBQSxNQUFNO1lBQ2xDLElBQU0sWUFBWSxHQUFHLEtBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDakQsT0FBTyxDQUNMLFlBQVk7aUJBQ1QsSUFBSSxFQUFFO2lCQUNOLFdBQVcsRUFBRTtpQkFDYixPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQ2pELENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsMENBQU8sR0FBUCxVQUFRLFVBQWU7UUFDckIsSUFBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDNUIsVUFBVSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDeEU7SUFDSCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxpREFBYyxHQUFkLFVBQWUsTUFBVztRQUN4QixJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsRUFBRTtZQUM5QixPQUFPLE1BQU0sQ0FBQztTQUNmO2FBQU0sSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNsQixPQUFPLEVBQUUsQ0FBQztTQUNYO2FBQU07WUFDTCxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUN4QztJQUNILENBQUM7SUFFRCwyQ0FBUSxHQUFSLFVBQVMsTUFBb0M7UUFDM0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUN0QyxDQUFDO0lBRU8sK0NBQVksR0FBcEI7UUFDRSxJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ2pFLElBQ0UsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMzQyxDQUFDLENBQUMsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUNsRTtZQUNBLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNoQzthQUFNO1lBQ0wsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ25DO0lBQ0gsQ0FBQztJQUVPLG9EQUFpQixHQUF6QixVQUEwQixNQUFXO1FBQ25DLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRTtZQUNqQyxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUM1QjtRQUVELElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDekYsQ0FBQztJQUVPLHVEQUFvQixHQUE1QixVQUE2QixNQUFXO1FBQ3RDLElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ25DLE1BQU0sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQzlCLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ3hCLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDNUI7WUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNwQztJQUNILENBQUM7SUFFRCw0QkFBNEI7SUFDNUIseURBQXNCLEdBQXRCLFVBQXVCLFNBQWM7UUFDbkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFcEMsSUFBSSxTQUFTLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFO1lBQ25ELElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7U0FDeEU7SUFDSCxDQUFDO0lBRVMsNERBQXlCLEdBQW5DO1FBQ0UsSUFBSSxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEUsQ0FBQztJQUVTLDJEQUF3QixHQUFsQyxVQUFtQyxhQUE0QjtRQUM3RCxJQUFJLENBQUMsMEJBQTBCLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzFELENBQUM7O2dCQTdLK0IsZ0JBQWdCLHVCQUE3QyxRQUFRO2dCQUNKLGlCQUFpQjtnQkFDZCxpQkFBaUI7Z0JBQ1AsMEJBQTBCOztJQS9CckM7UUFBUixLQUFLLEVBQUU7O29FQUE2QjtJQUM1QjtRQUFSLEtBQUssRUFBRTs7aUVBQXNCO0lBQ3JCO1FBQVIsS0FBSyxFQUFFOztnRUFBd0I7SUFDdkI7UUFBUixLQUFLLEVBQUU7O3dFQUFzQztJQUNyQztRQUFSLEtBQUssRUFBRTs7b0VBQThCO0lBQzdCO1FBQVIsS0FBSyxFQUFFOztnRkFBeUY7SUFDeEY7UUFBUixLQUFLLEVBQUU7OzhEQUFrQjtJQUNqQjtRQUFSLEtBQUssRUFBRTs7eUVBQXFDO0lBQ3BDO1FBQVIsS0FBSyxFQUFFOzsrREFBMkI7SUFFekI7UUFBVCxNQUFNLEVBQUU7MENBQWlCLFlBQVk7b0VBQTJCO0lBQ3ZEO1FBQVQsTUFBTSxFQUFFOzBDQUFvQixZQUFZO3VFQUEyQjtJQUMxRDtRQUFULE1BQU0sRUFBRTswQ0FBVSxZQUFZOzZEQUFnQztJQUNyRDtRQUFULE1BQU0sRUFBRTswQ0FBVyxZQUFZOzhEQUFnQztJQUdoRTtRQURDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLElBQUksRUFBRSxzQkFBc0IsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLENBQUM7MENBQy9ELHNCQUFzQjtxRUFBQztJQUM2QjtRQUFwRSxTQUFTLENBQUMsbUJBQW1CLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQzswQ0FBVyxVQUFVOzhEQUFDO0lBTWpGO1FBQVIsS0FBSyxFQUFFOzs7NERBRVA7SUE5QlUsd0JBQXdCO1FBTHBDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxrQkFBa0I7WUFDNUIsNjlDQUFnRDs7U0FFakQsQ0FBQztRQWtDRyxtQkFBQSxRQUFRLEVBQUUsQ0FBQTtpREFBbUIsZ0JBQWdCO1lBQ3pDLGlCQUFpQjtZQUNkLGlCQUFpQjtZQUNQLDBCQUEwQjtPQXBDbkMsd0JBQXdCLENBaU5wQztJQUFELCtCQUFDO0NBQUEsQUFqTkQsQ0FBOEMsb0JBQW9CLEdBaU5qRTtTQWpOWSx3QkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxuICBPdXRwdXQsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbnRyb2xDb250YWluZXIgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBNYXRBdXRvY29tcGxldGVTZWxlY3RlZEV2ZW50LCBNYXRBdXRvY29tcGxldGVUcmlnZ2VyLCBNYXRPcHRpb25TZWxlY3Rpb25DaGFuZ2UgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbCc7XG5pbXBvcnQgeyBMdXhGb3JtQ29tcG9uZW50QmFzZSB9IGZyb20gJy4uL2x1eC1mb3JtLW1vZGVsL2x1eC1mb3JtLWNvbXBvbmVudC1iYXNlLmNsYXNzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc3RhcnRXaXRoIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTHV4Q29uc29sZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9sdXgtdXRpbC9sdXgtY29uc29sZS5zZXJ2aWNlJztcbmltcG9ydCB7IEx1eENvbXBvbmVudHNDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vbHV4LWNvbXBvbmVudHMtY29uZmlnL2x1eC1jb21wb25lbnRzLWNvbmZpZy5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnbHV4LWF1dG9jb21wbGV0ZScsXG4gIHRlbXBsYXRlVXJsOiAnLi9sdXgtYXV0b2NvbXBsZXRlLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vbHV4LWF1dG9jb21wbGV0ZS5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIEx1eEF1dG9jb21wbGV0ZUNvbXBvbmVudCBleHRlbmRzIEx1eEZvcm1Db21wb25lbnRCYXNlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcbiAgcHJpdmF0ZSBzZWxlY3RlZCQ6IFJlcGxheVN1YmplY3Q8YW55PiA9IG5ldyBSZXBsYXlTdWJqZWN0PGFueT4oMSk7XG5cbiAgZmlsdGVyZWRPcHRpb25zOiBPYnNlcnZhYmxlPGFueT47XG5cbiAgQElucHV0KCkgbHV4UGxhY2Vob2xkZXI6IHN0cmluZyA9ICcnO1xuICBASW5wdXQoKSBsdXhSZWFkb25seTogYm9vbGVhbjtcbiAgQElucHV0KCkgbHV4T3B0aW9uczogYW55W10gPSBbXTtcbiAgQElucHV0KCkgbHV4T3B0aW9uTGFiZWxQcm9wOiBzdHJpbmcgPSAnbGFiZWwnO1xuICBASW5wdXQoKSBsdXhMb29rdXBEZWxheTogbnVtYmVyID0gNTAwO1xuICBASW5wdXQoKSBsdXhFcnJvck1lc3NhZ2VOb3RBbk9wdGlvbjogc3RyaW5nID0gJ0RlciBlaW5nZWdlYmVuZSBXZXJ0IGlzdCBuaWNodCBUZWlsIGRlciBBdXN3YWhsLic7XG4gIEBJbnB1dCgpIGx1eFRhZ0lkOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGx1eFNlbGVjdEFsbE9uQ2xpY2s6IGJvb2xlYW4gPSB0cnVlO1xuICBASW5wdXQoKSBsdXhTdHJpY3Q6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIEBPdXRwdXQoKSBsdXhWYWx1ZUNoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBsdXhPcHRpb25TZWxlY3RlZDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBsdXhCbHVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KCkgbHV4Rm9jdXM6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgQFZpZXdDaGlsZCgnYXV0b0NvbXBsZXRlSW5wdXQnLCB7IHJlYWQ6IE1hdEF1dG9jb21wbGV0ZVRyaWdnZXIsIHN0YXRpYzogZmFsc2UgfSlcbiAgbWF0QXV0b0NvbXBsZXRlOiBNYXRBdXRvY29tcGxldGVUcmlnZ2VyO1xuICBAVmlld0NoaWxkKCdhdXRvQ29tcGxldGVJbnB1dCcsIHsgcmVhZDogRWxlbWVudFJlZiwgc3RhdGljOiBmYWxzZSB9KSBtYXRJbnB1dDogRWxlbWVudFJlZjtcblxuICBnZXQgbHV4VmFsdWUoKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZSgpO1xuICB9XG5cbiAgQElucHV0KCkgc2V0IGx1eFZhbHVlKHZhbHVlOiBhbnkpIHtcbiAgICB0aGlzLnNldFZhbHVlKHZhbHVlKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpIGNvbnRyb2xDb250YWluZXI6IENvbnRyb2xDb250YWluZXIsXG4gICAgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBsb2dnZXI6IEx1eENvbnNvbGVTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBjb25maWc6IEx1eENvbXBvbmVudHNDb25maWdTZXJ2aWNlXG4gICkge1xuICAgIHN1cGVyKGNvbnRyb2xDb250YWluZXIsIGNkciwgbG9nZ2VyLCBjb25maWcpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgc3VwZXIubmdPbkluaXQoKTtcblxuICAgIHRoaXMuc2VsZWN0ZWQkLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSkuc3Vic2NyaWJlKHZhbHVlID0+IHtcbiAgICAgIGlmICh0aGlzLmx1eFN0cmljdCkge1xuICAgICAgICBpZiAodmFsdWUgPT09ICcnKSB7XG4gICAgICAgICAgdGhpcy5sdXhPcHRpb25TZWxlY3RlZC5lbWl0KG51bGwpO1xuICAgICAgICAgIHRoaXMubHV4VmFsdWVDaGFuZ2UuZW1pdChudWxsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBzZWxlY3RlZE9wdGlvbiA9IHRoaXMubHV4T3B0aW9ucy5maW5kKG9wdGlvbiA9PiB2YWx1ZSA9PT0gb3B0aW9uKTtcbiAgICAgICAgICBpZiAoc2VsZWN0ZWRPcHRpb24pIHtcbiAgICAgICAgICAgIHRoaXMubHV4T3B0aW9uU2VsZWN0ZWQuZW1pdChzZWxlY3RlZE9wdGlvbik7XG4gICAgICAgICAgICB0aGlzLmx1eFZhbHVlQ2hhbmdlLmVtaXQoc2VsZWN0ZWRPcHRpb24pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5sdXhPcHRpb25TZWxlY3RlZC5lbWl0KHZhbHVlKTtcbiAgICAgICAgdGhpcy5sdXhWYWx1ZUNoYW5nZS5lbWl0KHZhbHVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLm1hdEF1dG9Db21wbGV0ZS5wYW5lbENsb3NpbmdBY3Rpb25zXG4gICAgICAucGlwZShkZWJvdW5jZVRpbWUodGhpcy5sdXhMb29rdXBEZWxheSkpXG4gICAgICAuc3Vic2NyaWJlKCh2YWx1ZTogTWF0T3B0aW9uU2VsZWN0aW9uQ2hhbmdlKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmx1eFN0cmljdCkge1xuICAgICAgICAgIGNvbnN0IGZpbHRlclJlc3VsdCA9IHRoaXMuZmlsdGVyKHRoaXMuZ2V0T3B0aW9uTGFiZWwodGhpcy5sdXhWYWx1ZSkpO1xuXG4gICAgICAgICAgaWYgKGZpbHRlclJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybUNvbnRyb2wuc2V0VmFsdWUoZmlsdGVyUmVzdWx0WzBdKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aGlzLmhhbmRsZUVycm9ycygpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIHRoaXMuZmlsdGVyZWRPcHRpb25zID0gdGhpcy5mb3JtQ29udHJvbC52YWx1ZUNoYW5nZXMucGlwZShcbiAgICAgIHN0YXJ0V2l0aCgnJyksXG4gICAgICBkZWJvdW5jZVRpbWUodGhpcy5sdXhMb29rdXBEZWxheSksXG4gICAgICBtYXAodmFsdWUgPT4gdGhpcy5nZXRPcHRpb25MYWJlbCh2YWx1ZSkpLFxuICAgICAgbWFwKCgpID0+IHtcbiAgICAgICAgY29uc3QgZmlsdGVyTGFiZWwgPSB0aGlzLmdldE9wdGlvbkxhYmVsKHRoaXMubHV4VmFsdWUpO1xuICAgICAgICByZXR1cm4gZmlsdGVyTGFiZWwgPyB0aGlzLmZpbHRlcihmaWx0ZXJMYWJlbCkgOiB0aGlzLmx1eE9wdGlvbnM7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQG92ZXJyaWRlIGVycm9yTWVzc2FnZU1vZGlmaWVyIC0gTW9kaWZpa2F0aW9uIGRlciBGZWhsZXJtZWxkdW5nXG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKiBAcGFyYW0gZXJyb3JzXG4gICAqL1xuICBlcnJvck1lc3NhZ2VNb2RpZmllcih2YWx1ZSwgZXJyb3JzKSB7XG4gICAgaWYgKGVycm9yc1snaW5jb3JyZWN0J10pIHtcbiAgICAgIHJldHVybiB0aGlzLmx1eEVycm9yTWVzc2FnZU5vdEFuT3B0aW9uO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2VsdCBkaWUgRGFyc3RlbGx1bmcgZGVyIGdld2FlaGx0ZW4gT3B0aW9uIGltIE5vcm1hbGZhbGwuXG4gICAqIChBdXNuYWhtZTogRm9jdXMtVmVybHVzdClcbiAgICogQHBhcmFtIG9wdGlvblxuICAgKiBAcmV0dXJucyBzdHJpbmdcbiAgICovXG4gIGRpc3BsYXlGbihvcHRpb246IGFueSk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uTGFiZWwodGhpcy5sdXhWYWx1ZSk7XG4gIH1cblxuICAvKipcbiAgICogRmlsdGVydCBkYXMgT3B0aW9ucy1BcnJheSBuYWNoIGRlbSBmaWx0ZXJUZXJtIHVuZFxuICAgKiBnaWJ0IGRhcyBFcmdlYm5pcyBhbHMgQXJyYXkgenVydWVjay5cbiAgICogQHBhcmFtIGZpbHRlclRlcm1cbiAgICogQHJldHVybnMgYW55W11cbiAgICovXG4gIGZpbHRlcihmaWx0ZXJUZXJtOiBhbnkpIHtcbiAgICByZXR1cm4gdGhpcy5sdXhPcHRpb25zLmZpbHRlcihvcHRpb24gPT4ge1xuICAgICAgY29uc3QgY29tcGFyZVZhbHVlID0gdGhpcy5nZXRPcHRpb25MYWJlbChvcHRpb24pO1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgY29tcGFyZVZhbHVlXG4gICAgICAgICAgLnRyaW0oKVxuICAgICAgICAgIC50b0xvd2VyQ2FzZSgpXG4gICAgICAgICAgLmluZGV4T2YoZmlsdGVyVGVybS50cmltKCkudG9Mb3dlckNhc2UoKSkgPiAtMVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGljay1FdmVudCBIYW5kbGluZ1xuICAgKiBTZWxla3RpZXJ0IGRlbiBnZXNhbXRlbiBUZXh0IGltIElucHV0LCB3ZW5uIHNlbGVjdEFsbE9uQ2xpY2sgPSB0cnVlIGlzdC5cbiAgICogQHBhcmFtIGNsaWNrRXZlbnRcbiAgICovXG4gIG9uQ2xpY2soY2xpY2tFdmVudDogYW55KSB7XG4gICAgaWYgKHRoaXMubHV4U2VsZWN0QWxsT25DbGljaykge1xuICAgICAgY2xpY2tFdmVudC50YXJnZXQuc2V0U2VsZWN0aW9uUmFuZ2UoMCwgY2xpY2tFdmVudC50YXJnZXQudmFsdWUubGVuZ3RoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2lidCBkZW4gZGFyenVzdGVsbGVuZGVuIFdlcnQgZWluZXIgT3B0aW9uIGJ6dy5cbiAgICogZGllIE9wdGlvbiBzZWxic3QgKHdlbm4gc3RyaW5nKSB3aWRlci5cbiAgICogQHBhcmFtIG9wdGlvblxuICAgKiBAcmV0dXJucyBhbnlcbiAgICovXG4gIGdldE9wdGlvbkxhYmVsKG9wdGlvbjogYW55KSB7XG4gICAgaWYgKHR5cGVvZiBvcHRpb24gPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gb3B0aW9uO1xuICAgIH0gZWxzZSBpZiAoIW9wdGlvbikge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gb3B0aW9uW3RoaXMubHV4T3B0aW9uTGFiZWxQcm9wXTtcbiAgICB9XG4gIH1cblxuICBzZWxlY3RlZCgkZXZlbnQ6IE1hdEF1dG9jb21wbGV0ZVNlbGVjdGVkRXZlbnQpIHtcbiAgICB0aGlzLmx1eFZhbHVlID0gJGV2ZW50Lm9wdGlvbi52YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRXJyb3JzKCkge1xuICAgIGNvbnN0IGVycm9ycyA9IHRoaXMuZm9ybUNvbnRyb2wgPyB0aGlzLmZvcm1Db250cm9sLmVycm9ycyA6IG51bGw7XG4gICAgaWYgKFxuICAgICAgdGhpcy5sdXhPcHRpb25zLmluZGV4T2YodGhpcy5sdXhWYWx1ZSkgPiAtMSB8fFxuICAgICAgKCEhZXJyb3JzICYmIE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoID4gMCAmJiBlcnJvcnNbJ3JlcXVpcmVkJ10pXG4gICAgKSB7XG4gICAgICB0aGlzLmhhbmRsZU90aGVyRXJyb3JzKGVycm9ycyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaGFuZGxlSW5jb3JyZWN0RXJyb3IoZXJyb3JzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZU90aGVyRXJyb3JzKGVycm9yczogYW55KSB7XG4gICAgaWYgKGVycm9ycyAmJiBlcnJvcnNbJ2luY29ycmVjdCddKSB7XG4gICAgICBkZWxldGUgZXJyb3JzWydpbmNvcnJlY3QnXTtcbiAgICB9XG5cbiAgICB0aGlzLmZvcm1Db250cm9sLnNldEVycm9ycyhlcnJvcnMgJiYgT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGggIT09IDAgPyBlcnJvcnMgOiBudWxsKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlSW5jb3JyZWN0RXJyb3IoZXJyb3JzOiBhbnkpIHtcbiAgICBpZiAodGhpcy5sdXhTdHJpY3QgJiYgdGhpcy5sdXhWYWx1ZSkge1xuICAgICAgZXJyb3JzID0gZXJyb3JzID8gZXJyb3JzIDoge307XG4gICAgICBpZiAoIWVycm9yc1snaW5jb3JyZWN0J10pIHtcbiAgICAgICAgZXJyb3JzWydpbmNvcnJlY3QnXSA9IHRydWU7XG4gICAgICB9XG4gICAgICB0aGlzLmZvcm1Db250cm9sLnNldEVycm9ycyhlcnJvcnMpO1xuICAgIH1cbiAgfVxuXG4gIC8vIHJlZ2lvbiBvdmVycmlkZGVuIG1ldGhvZHNcbiAgbm90aWZ5Rm9ybVZhbHVlQ2hhbmdlZChmb3JtVmFsdWU6IGFueSkge1xuICAgIHRoaXMuc2VsZWN0ZWQkLm5leHQoZm9ybVZhbHVlKTtcbiAgICB0aGlzLmx1eFZhbHVlQ2hhbmdlLmVtaXQoZm9ybVZhbHVlKTtcblxuICAgIGlmIChmb3JtVmFsdWUgJiYgZm9ybVZhbHVlW3RoaXMubHV4T3B0aW9uTGFiZWxQcm9wXSkge1xuICAgICAgdGhpcy5tYXRJbnB1dC5uYXRpdmVFbGVtZW50LnZhbHVlID0gZm9ybVZhbHVlW3RoaXMubHV4T3B0aW9uTGFiZWxQcm9wXTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgdHJpZ2dlck91dHB1dFBhdHRlcm5DaGVjaygpIHtcbiAgICB0aGlzLmNoZWNrT3V0cHV0UGF0dGVyblZpb2xhdGlvbih0aGlzLmx1eFZhbHVlQ2hhbmdlLm9ic2VydmVycyk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdHJpZ2dlcklucHV0UGF0dGVybkNoZWNrKHNpbXBsZUNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICB0aGlzLmNoZWNrSW5wdXRQYXR0ZXJuVmlvbGF0aW9uKHNpbXBsZUNoYW5nZXMubHV4VmFsdWUpO1xuICB9XG5cbiAgLy8gZW5kcmVnaW9uXG59XG4iXX0=