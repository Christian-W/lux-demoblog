import * as tslib_1 from "tslib";
import { AfterViewInit, Directive, ElementRef, Input, OnDestroy, OnInit, Renderer2 } from '@angular/core';
import { LuxUtil } from '../../lux-util/lux-util';
import { LuxComponentsConfigService } from '../../lux-components-config/lux-components-config.service';
import { luxFormControlSelektor } from '../../lux-form/lux-form-control/lux-form-control.component';
var LuxTagIdDirective = /** @class */ (function () {
    function LuxTagIdDirective(elementRef, renderer, componentsConfigService) {
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.componentsConfigService = componentsConfigService;
    }
    LuxTagIdDirective_1 = LuxTagIdDirective;
    LuxTagIdDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.configSubscription = this.componentsConfigService.config.subscribe(function (newConfig) {
            _this.generateLuxTagIds = newConfig.generateLuxTagIds;
        });
    };
    LuxTagIdDirective.prototype.ngAfterViewInit = function () {
        if (this.generateLuxTagIds) {
            var luxComponent = this.findLuxComponent(this.elementRef.nativeElement);
            if (luxComponent) {
                var newTagId = this.luxTagId;
                if (!newTagId) {
                    newTagId = this.getLuxTagId(luxComponent);
                }
                if (newTagId) {
                    newTagId = this.mergeTagIds(this.getLuxTagIdParent(luxComponent.parentElement, ''), luxComponent.nodeName + LuxTagIdDirective_1.sepComponent + newTagId);
                    newTagId = newTagId.toLowerCase();
                    this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                }
                else {
                    var usedLabel = false;
                    if (luxComponent.getAttribute('luxLabel')) {
                        newTagId = this.mergeTagIds(luxComponent.getAttribute('luxLabel'), newTagId);
                        newTagId = newTagId.toLowerCase();
                        this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                        usedLabel = true;
                    }
                    else if (luxComponent.getAttribute('ng-reflect-lux-label')) {
                        newTagId = this.mergeTagIds(luxComponent.getAttribute('ng-reflect-lux-label'), newTagId);
                        newTagId = newTagId.toLowerCase();
                        this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                        usedLabel = true;
                    }
                    else if (luxComponent.getAttribute('ng-reflect-label')) {
                        newTagId = this.mergeTagIds(luxComponent.getAttribute('ng-reflect-label'), newTagId);
                        newTagId = newTagId.toLowerCase();
                        this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                        usedLabel = true;
                    }
                    else if (luxComponent.getElementsByClassName('lux-form-label')[0]) {
                        newTagId = this.mergeTagIds(luxComponent.getElementsByClassName('lux-form-label')[0].textContent.trim(), newTagId);
                        newTagId = newTagId.toLowerCase();
                        this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                        usedLabel = true;
                    }
                    if (!usedLabel) {
                        console.warn('Dem Tag "' +
                            this.getNodeName(luxComponent) +
                            '(' +
                            this.getParentPath(luxComponent.parentElement, '') +
                            ')' +
                            '" fehlt das luxTagId-Attribut. Dieses Attribut wird für die automatischen Tests benötigt.');
                    }
                }
            }
        }
    };
    LuxTagIdDirective.prototype.ngOnDestroy = function () {
        this.configSubscription.unsubscribe();
    };
    LuxTagIdDirective.prototype.getParentPath = function (element, currentTagId) {
        if (element && element.parentElement) {
            return this.getParentPath(element.parentElement, currentTagId + '.' + this.getNodeName(element.parentElement));
        }
        return currentTagId;
    };
    LuxTagIdDirective.prototype.getLuxTagIdParent = function (element, currentTagId) {
        if (element) {
            var newTagId = currentTagId;
            if (element.hasAttribute('luxTagId')) {
                newTagId = this.mergeTagIds('luxTagId', newTagId);
            }
            else if (element.hasAttribute(LuxTagIdDirective_1.luxTagIdAttrName)) {
                newTagId = this.mergeTagIds(element.getAttribute(LuxTagIdDirective_1.luxTagIdAttrName), newTagId);
            }
            else if (element.hasAttribute('luxcontrolbinding')) {
                newTagId = this.mergeTagIds(element.getAttribute('luxcontrolbinding'), newTagId);
            }
            else if (element.hasAttribute('formgroupname')) {
                newTagId = this.mergeTagIds('formgroup' + LuxTagIdDirective_1.sepComponent + element.getAttribute('formgroupname'), newTagId);
            }
            return this.getLuxTagIdParent(element.parentElement, newTagId);
        }
        return currentTagId;
    };
    LuxTagIdDirective.prototype.mergeTagIds = function (tagId1, tagId2) {
        var tagId;
        if (!LuxUtil.isEmpty(tagId1) && !LuxUtil.isEmpty(tagId2)) {
            tagId = tagId1 + LuxTagIdDirective_1.sepParent + tagId2;
        }
        else if (!LuxUtil.isEmpty(tagId1) && LuxUtil.isEmpty(tagId2)) {
            tagId = tagId1;
        }
        else if (LuxUtil.isEmpty(tagId1) && !LuxUtil.isEmpty(tagId2)) {
            tagId = tagId2;
        }
        else {
            tagId = '';
        }
        return tagId;
    };
    LuxTagIdDirective.prototype.getLuxTagId = function (element) {
        var newId = '';
        if (element) {
            if (element.hasAttribute('luxTagId')) {
                newId = element.getAttribute('luxTagId');
            }
            else if (element.hasAttribute(LuxTagIdDirective_1.luxTagIdAttrName)) {
                newId = element.getAttribute(LuxTagIdDirective_1.luxTagIdAttrName);
            }
            else if (element.hasAttribute('luxcontrolbinding')) {
                newId = element.getAttribute('luxcontrolbinding');
            }
            else if (element.hasAttribute('formgroupname')) {
                newId = element.getAttribute('formgroupname');
            }
        }
        return newId;
    };
    LuxTagIdDirective.prototype.findLuxComponent = function (element) {
        if (element) {
            var nodeName = this.getNodeName(element);
            if (nodeName && nodeName.startsWith('lux-'.toUpperCase()) && nodeName !== luxFormControlSelektor.toUpperCase()) {
                return element;
            }
            else {
                return this.findLuxComponent(element.parentElement);
            }
        }
        return null;
    };
    LuxTagIdDirective.prototype.getNodeName = function (element) {
        return element && element.nodeName ? element.nodeName : '';
    };
    var LuxTagIdDirective_1;
    LuxTagIdDirective.luxTagIdAttrName = 'data-luxtagid';
    LuxTagIdDirective.sepParent = '.';
    LuxTagIdDirective.sepComponent = '#';
    LuxTagIdDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Renderer2 },
        { type: LuxComponentsConfigService }
    ]; };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], LuxTagIdDirective.prototype, "luxTagId", void 0);
    LuxTagIdDirective = LuxTagIdDirective_1 = tslib_1.__decorate([
        Directive({
            selector: '[luxTagIdHandler]'
        }),
        tslib_1.__metadata("design:paramtypes", [ElementRef,
            Renderer2,
            LuxComponentsConfigService])
    ], LuxTagIdDirective);
    return LuxTagIdDirective;
}());
export { LuxTagIdDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHV4LXRhZy1pZC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaWhrLWdmaS9sdXgtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbW9kdWxlcy9sdXgtZGlyZWN0aXZlcy9sdXgtdGFnLWlkL2x1eC10YWctaWQuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsYUFBYSxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFHLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwyREFBMkQsQ0FBQztBQUd2RyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0REFBNEQsQ0FBQztBQUtwRztJQVdFLDJCQUNVLFVBQXNCLEVBQ3RCLFFBQW1CLEVBQ3BCLHVCQUFtRDtRQUZsRCxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDcEIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUE0QjtJQUN6RCxDQUFDOzBCQWZPLGlCQUFpQjtJQWlCNUIsb0NBQVEsR0FBUjtRQUFBLGlCQU1DO1FBTEMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUNyRSxVQUFDLFNBQXdDO1lBQ3ZDLEtBQUksQ0FBQyxpQkFBaUIsR0FBRyxTQUFTLENBQUMsaUJBQWlCLENBQUM7UUFDdkQsQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0lBRUQsMkNBQWUsR0FBZjtRQUNFLElBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQzFCLElBQU0sWUFBWSxHQUFZLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFD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RU8sdUNBQVcsR0FBbkIsVUFBb0IsT0FBZ0I7UUFDbEMsT0FBTyxPQUFPLElBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzdELENBQUM7O0lBNUtzQixrQ0FBZ0IsR0FBVyxlQUFlLENBQUM7SUFDM0MsMkJBQVMsR0FBVyxHQUFHLENBQUM7SUFDeEIsOEJBQVksR0FBVyxHQUFHLENBQUM7O2dCQVM1QixVQUFVO2dCQUNaLFNBQVM7Z0JBQ0ssMEJBQTBCOztJQVBuRDtRQUFSLEtBQUssRUFBRTs7dURBQWtCO0lBUGYsaUJBQWlCO1FBSDdCLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxtQkFBbUI7U0FDOUIsQ0FBQztpREFhc0IsVUFBVTtZQUNaLFNBQVM7WUFDSywwQkFBMEI7T0FkakQsaUJBQWlCLENBOEs3QjtJQUFELHdCQUFDO0NBQUEsQUE5S0QsSUE4S0M7U0E5S1ksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbnB1dCwgT25EZXN0cm95LCBPbkluaXQsIFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTHV4VXRpbCB9IGZyb20gJy4uLy4uL2x1eC11dGlsL2x1eC11dGlsJztcbmltcG9ydCB7IEx1eENvbXBvbmVudHNDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vbHV4LWNvbXBvbmVudHMtY29uZmlnL2x1eC1jb21wb25lbnRzLWNvbmZpZy5zZXJ2aWNlJztcbmltcG9ydCB7IEx1eENvbXBvbmVudHNDb25maWdQYXJhbWV0ZXJzIH0gZnJvbSAnLi4vLi4vbHV4LWNvbXBvbmVudHMtY29uZmlnL2x1eC1jb21wb25lbnRzLWNvbmZpZy1wYXJhbWV0ZXJzLmludGVyZmFjZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGx1eEZvcm1Db250cm9sU2VsZWt0b3IgfSBmcm9tICcuLi8uLi9sdXgtZm9ybS9sdXgtZm9ybS1jb250cm9sL2x1eC1mb3JtLWNvbnRyb2wuY29tcG9uZW50JztcblxuQERpcmVjdGl2ZSh7XG4gIHNlbGVjdG9yOiAnW2x1eFRhZ0lkSGFuZGxlcl0nXG59KVxuZXhwb3J0IGNsYXNzIEx1eFRhZ0lkRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IGx1eFRhZ0lkQXR0ck5hbWU6IHN0cmluZyA9ICdkYXRhLWx1eHRhZ2lkJztcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBzZXBQYXJlbnQ6IHN0cmluZyA9ICcuJztcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBzZXBDb21wb25lbnQ6IHN0cmluZyA9ICcjJztcblxuICBwcml2YXRlIGNvbmZpZ1N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIEBJbnB1dCgpIGx1eFRhZ0lkOiBzdHJpbmc7XG5cbiAgZ2VuZXJhdGVMdXhUYWdJZHM6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwdWJsaWMgY29tcG9uZW50c0NvbmZpZ1NlcnZpY2U6IEx1eENvbXBvbmVudHNDb25maWdTZXJ2aWNlXG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmNvbmZpZ1N1YnNjcmlwdGlvbiA9IHRoaXMuY29tcG9uZW50c0NvbmZpZ1NlcnZpY2UuY29uZmlnLnN1YnNjcmliZShcbiAgICAgIChuZXdDb25maWc6IEx1eENvbXBvbmVudHNDb25maWdQYXJhbWV0ZXJzKSA9PiB7XG4gICAgICAgIHRoaXMuZ2VuZXJhdGVMdXhUYWdJZHMgPSBuZXdDb25maWcuZ2VuZXJhdGVMdXhUYWdJZHM7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICBpZiAodGhpcy5nZW5lcmF0ZUx1eFRhZ0lkcykge1xuICAgICAgY29uc3QgbHV4Q29tcG9uZW50OiBFbGVtZW50ID0gdGhpcy5maW5kTHV4Q29tcG9uZW50KHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KTtcblxuICAgICAgaWYgKGx1eENvbXBvbmVudCkge1xuICAgICAgICBsZXQgbmV3VGFnSWQgPSB0aGlzLmx1eFRhZ0lkO1xuXG4gICAgICAgIGlmICghbmV3VGFnSWQpIHtcbiAgICAgICAgICBuZXdUYWdJZCA9IHRoaXMuZ2V0THV4VGFnSWQobHV4Q29tcG9uZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChuZXdUYWdJZCkge1xuICAgICAgICAgIG5ld1RhZ0lkID0gdGhpcy5tZXJnZVRhZ0lkcyhcbiAgICAgICAgICAgIHRoaXMuZ2V0THV4VGFnSWRQYXJlbnQobHV4Q29tcG9uZW50LnBhcmVudEVsZW1lbnQsICcnKSxcbiAgICAgICAgICAgIGx1eENvbXBvbmVudC5ub2RlTmFtZSArIEx1eFRhZ0lkRGlyZWN0aXZlLnNlcENvbXBvbmVudCArIG5ld1RhZ0lkXG4gICAgICAgICAgKTtcbiAgICAgICAgICBuZXdUYWdJZCA9IG5ld1RhZ0lkLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShsdXhDb21wb25lbnQsIEx1eFRhZ0lkRGlyZWN0aXZlLmx1eFRhZ0lkQXR0ck5hbWUsIG5ld1RhZ0lkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsZXQgdXNlZExhYmVsID0gZmFsc2U7XG4gICAgICAgICAgaWYgKGx1eENvbXBvbmVudC5nZXRBdHRyaWJ1dGUoJ2x1eExhYmVsJykpIHtcbiAgICAgICAgICAgIG5ld1RhZ0lkID0gdGhpcy5tZXJnZVRhZ0lkcyhsdXhDb21wb25lbnQuZ2V0QXR0cmlidXRlKCdsdXhMYWJlbCcpLCBuZXdUYWdJZCk7XG4gICAgICAgICAgICBuZXdUYWdJZCA9IG5ld1RhZ0lkLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShsdXhDb21wb25lbnQsIEx1eFRhZ0lkRGlyZWN0aXZlLmx1eFRhZ0lkQXR0ck5hbWUsIG5ld1RhZ0lkKTtcblxuICAgICAgICAgICAgdXNlZExhYmVsID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGx1eENvbXBvbmVudC5nZXRBdHRyaWJ1dGUoJ25nLXJlZmxlY3QtbHV4LWxhYmVsJykpIHtcbiAgICAgICAgICAgIG5ld1RhZ0lkID0gdGhpcy5tZXJnZVRhZ0lkcyhsdXhDb21wb25lbnQuZ2V0QXR0cmlidXRlKCduZy1yZWZsZWN0LWx1eC1sYWJlbCcpLCBuZXdUYWdJZCk7XG4gICAgICAgICAgICBuZXdUYWdJZCA9IG5ld1RhZ0lkLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShsdXhDb21wb25lbnQsIEx1eFRhZ0lkRGlyZWN0aXZlLmx1eFRhZ0lkQXR0ck5hbWUsIG5ld1RhZ0lkKTtcblxuICAgICAgICAgICAgdXNlZExhYmVsID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGx1eENvbXBvbmVudC5nZXRBdHRyaWJ1dGUoJ25nLXJlZmxlY3QtbGFiZWwnKSkge1xuICAgICAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKGx1eENvbXBvbmVudC5nZXRBdHRyaWJ1dGUoJ25nLXJlZmxlY3QtbGFiZWwnKSwgbmV3VGFnSWQpO1xuICAgICAgICAgICAgbmV3VGFnSWQgPSBuZXdUYWdJZC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUobHV4Q29tcG9uZW50LCBMdXhUYWdJZERpcmVjdGl2ZS5sdXhUYWdJZEF0dHJOYW1lLCBuZXdUYWdJZCk7XG5cbiAgICAgICAgICAgIHVzZWRMYWJlbCA9IHRydWU7XG4gICAgICAgICAgfSBlbHNlIGlmIChsdXhDb21wb25lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnbHV4LWZvcm0tbGFiZWwnKVswXSkge1xuICAgICAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKFxuICAgICAgICAgICAgICBsdXhDb21wb25lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSgnbHV4LWZvcm0tbGFiZWwnKVswXS50ZXh0Q29udGVudC50cmltKCksXG4gICAgICAgICAgICAgIG5ld1RhZ0lkXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgbmV3VGFnSWQgPSBuZXdUYWdJZC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUobHV4Q29tcG9uZW50LCBMdXhUYWdJZERpcmVjdGl2ZS5sdXhUYWdJZEF0dHJOYW1lLCBuZXdUYWdJZCk7XG5cbiAgICAgICAgICAgIHVzZWRMYWJlbCA9IHRydWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKCF1c2VkTGFiZWwpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICAgJ0RlbSBUYWcgXCInICtcbiAgICAgICAgICAgICAgICB0aGlzLmdldE5vZGVOYW1lKGx1eENvbXBvbmVudCkgK1xuICAgICAgICAgICAgICAgICcoJyArXG4gICAgICAgICAgICAgICAgdGhpcy5nZXRQYXJlbnRQYXRoKGx1eENvbXBvbmVudC5wYXJlbnRFbGVtZW50LCAnJykgK1xuICAgICAgICAgICAgICAgICcpJyArXG4gICAgICAgICAgICAgICAgJ1wiIGZlaGx0IGRhcyBsdXhUYWdJZC1BdHRyaWJ1dC4gRGllc2VzIEF0dHJpYnV0IHdpcmQgZsO8ciBkaWUgYXV0b21hdGlzY2hlbiBUZXN0cyBiZW7DtnRpZ3QuJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmNvbmZpZ1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQYXJlbnRQYXRoKGVsZW1lbnQ6IEVsZW1lbnQsIGN1cnJlbnRUYWdJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoZWxlbWVudCAmJiBlbGVtZW50LnBhcmVudEVsZW1lbnQpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldFBhcmVudFBhdGgoZWxlbWVudC5wYXJlbnRFbGVtZW50LCBjdXJyZW50VGFnSWQgKyAnLicgKyB0aGlzLmdldE5vZGVOYW1lKGVsZW1lbnQucGFyZW50RWxlbWVudCkpO1xuICAgIH1cblxuICAgIHJldHVybiBjdXJyZW50VGFnSWQ7XG4gIH1cblxuICBwcml2YXRlIGdldEx1eFRhZ0lkUGFyZW50KGVsZW1lbnQ6IEVsZW1lbnQsIGN1cnJlbnRUYWdJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoZWxlbWVudCkge1xuICAgICAgbGV0IG5ld1RhZ0lkOiBzdHJpbmcgPSBjdXJyZW50VGFnSWQ7XG4gICAgICBpZiAoZWxlbWVudC5oYXNBdHRyaWJ1dGUoJ2x1eFRhZ0lkJykpIHtcbiAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKCdsdXhUYWdJZCcsIG5ld1RhZ0lkKTtcbiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5oYXNBdHRyaWJ1dGUoTHV4VGFnSWREaXJlY3RpdmUubHV4VGFnSWRBdHRyTmFtZSkpIHtcbiAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKGVsZW1lbnQuZ2V0QXR0cmlidXRlKEx1eFRhZ0lkRGlyZWN0aXZlLmx1eFRhZ0lkQXR0ck5hbWUpLCBuZXdUYWdJZCk7XG4gICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaGFzQXR0cmlidXRlKCdsdXhjb250cm9sYmluZGluZycpKSB7XG4gICAgICAgIG5ld1RhZ0lkID0gdGhpcy5tZXJnZVRhZ0lkcyhlbGVtZW50LmdldEF0dHJpYnV0ZSgnbHV4Y29udHJvbGJpbmRpbmcnKSwgbmV3VGFnSWQpO1xuICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lmhhc0F0dHJpYnV0ZSgnZm9ybWdyb3VwbmFtZScpKSB7XG4gICAgICAgIG5ld1RhZ0lkID0gdGhpcy5tZXJnZVRhZ0lkcyhcbiAgICAgICAgICAnZm9ybWdyb3VwJyArIEx1eFRhZ0lkRGlyZWN0aXZlLnNlcENvbXBvbmVudCArIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdmb3JtZ3JvdXBuYW1lJyksXG4gICAgICAgICAgbmV3VGFnSWRcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuZ2V0THV4VGFnSWRQYXJlbnQoZWxlbWVudC5wYXJlbnRFbGVtZW50LCBuZXdUYWdJZCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnRUYWdJZDtcbiAgfVxuXG4gIHByaXZhdGUgbWVyZ2VUYWdJZHModGFnSWQxOiBzdHJpbmcsIHRhZ0lkMjogc3RyaW5nKSB7XG4gICAgbGV0IHRhZ0lkOiBzdHJpbmc7XG5cbiAgICBpZiAoIUx1eFV0aWwuaXNFbXB0eSh0YWdJZDEpICYmICFMdXhVdGlsLmlzRW1wdHkodGFnSWQyKSkge1xuICAgICAgdGFnSWQgPSB0YWdJZDEgKyBMdXhUYWdJZERpcmVjdGl2ZS5zZXBQYXJlbnQgKyB0YWdJZDI7XG4gICAgfSBlbHNlIGlmICghTHV4VXRpbC5pc0VtcHR5KHRhZ0lkMSkgJiYgTHV4VXRpbC5pc0VtcHR5KHRhZ0lkMikpIHtcbiAgICAgIHRhZ0lkID0gdGFnSWQxO1xuICAgIH0gZWxzZSBpZiAoTHV4VXRpbC5pc0VtcHR5KHRhZ0lkMSkgJiYgIUx1eFV0aWwuaXNFbXB0eSh0YWdJZDIpKSB7XG4gICAgICB0YWdJZCA9IHRhZ0lkMjtcbiAgICB9IGVsc2Uge1xuICAgICAgdGFnSWQgPSAnJztcbiAgICB9XG5cbiAgICByZXR1cm4gdGFnSWQ7XG4gIH1cblxuICBwcml2YXRlIGdldEx1eFRhZ0lkKGVsZW1lbnQ6IEVsZW1lbnQpOiBzdHJpbmcge1xuICAgIGxldCBuZXdJZCA9ICcnO1xuXG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIGlmIChlbGVtZW50Lmhhc0F0dHJpYnV0ZSgnbHV4VGFnSWQnKSkge1xuICAgICAgICBuZXdJZCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdsdXhUYWdJZCcpO1xuICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lmhhc0F0dHJpYnV0ZShMdXhUYWdJZERpcmVjdGl2ZS5sdXhUYWdJZEF0dHJOYW1lKSkge1xuICAgICAgICBuZXdJZCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKEx1eFRhZ0lkRGlyZWN0aXZlLmx1eFRhZ0lkQXR0ck5hbWUpO1xuICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lmhhc0F0dHJpYnV0ZSgnbHV4Y29udHJvbGJpbmRpbmcnKSkge1xuICAgICAgICBuZXdJZCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdsdXhjb250cm9sYmluZGluZycpO1xuICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lmhhc0F0dHJpYnV0ZSgnZm9ybWdyb3VwbmFtZScpKSB7XG4gICAgICAgIG5ld0lkID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2Zvcm1ncm91cG5hbWUnKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbmV3SWQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRMdXhDb21wb25lbnQoZWxlbWVudDogRWxlbWVudCk6IEVsZW1lbnQge1xuICAgIGlmIChlbGVtZW50KSB7XG4gICAgICBjb25zdCBub2RlTmFtZTogc3RyaW5nID0gdGhpcy5nZXROb2RlTmFtZShlbGVtZW50KTtcbiAgICAgIGlmIChub2RlTmFtZSAmJiBub2RlTmFtZS5zdGFydHNXaXRoKCdsdXgtJy50b1VwcGVyQ2FzZSgpKSAmJiBub2RlTmFtZSAhPT0gbHV4Rm9ybUNvbnRyb2xTZWxla3Rvci50b1VwcGVyQ2FzZSgpKSB7XG4gICAgICAgIHJldHVybiBlbGVtZW50O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmluZEx1eENvbXBvbmVudChlbGVtZW50LnBhcmVudEVsZW1lbnQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROb2RlTmFtZShlbGVtZW50OiBFbGVtZW50KTogc3RyaW5nIHtcbiAgICByZXR1cm4gZWxlbWVudCAmJiBlbGVtZW50Lm5vZGVOYW1lID8gZWxlbWVudC5ub2RlTmFtZSA6ICcnO1xuICB9XG59XG4iXX0=