import * as tslib_1 from "tslib";
import { AfterViewInit, ChangeDetectorRef, Component, ElementRef, EventEmitter, Input, OnInit, Optional, Output, SimpleChanges, ViewChild } from '@angular/core';
import { ControlContainer } from '@angular/forms';
import { MatAutocompleteTrigger } from '@angular/material';
import { LuxFormComponentBase } from '../lux-form-model/lux-form-component-base.class';
import { debounceTime, distinctUntilChanged, map, startWith } from 'rxjs/operators';
import { ReplaySubject } from 'rxjs';
import { LuxConsoleService } from '../../lux-util/lux-console.service';
import { LuxComponentsConfigService } from '../../lux-components-config/lux-components-config.service';
let LuxAutocompleteComponent = class LuxAutocompleteComponent extends LuxFormComponentBase {
    constructor(controlContainer, cdr, logger, config) {
        super(controlContainer, cdr, logger, config);
        this.config = config;
        this.selected$ = new ReplaySubject(1);
        this.luxPlaceholder = '';
        this.luxOptions = [];
        this.luxOptionLabelProp = 'label';
        this.luxLookupDelay = 500;
        this.luxErrorMessageNotAnOption = 'Der eingegebene Wert ist nicht Teil der Auswahl.';
        this.luxSelectAllOnClick = true;
        this.luxStrict = true;
        this.luxValueChange = new EventEmitter();
        this.luxOptionSelected = new EventEmitter();
        this.luxBlur = new EventEmitter();
        this.luxFocus = new EventEmitter();
    }
    get luxValue() {
        return this.getValue();
    }
    set luxValue(value) {
        this.setValue(value);
    }
    ngOnInit() {
        super.ngOnInit();
        this.selected$.pipe(distinctUntilChanged()).subscribe(value => {
            if (this.luxStrict) {
                if (value === '') {
                    this.luxOptionSelected.emit(null);
                    this.luxValueChange.emit(null);
                }
                else {
                    const selectedOption = this.luxOptions.find(option => value === option);
                    if (selectedOption) {
                        this.luxOptionSelected.emit(selectedOption);
                        this.luxValueChange.emit(selectedOption);
                    }
                }
            }
            else {
                this.luxOptionSelected.emit(value);
                this.luxValueChange.emit(value);
            }
        });
    }
    ngAfterViewInit() {
        this.matAutoComplete.panelClosingActions
            .pipe(debounceTime(this.luxLookupDelay))
            .subscribe((value) => {
            if (this.luxStrict) {
                const filterResult = this.filter(this.getOptionLabel(this.luxValue));
                if (filterResult.length === 1) {
                    this.formControl.setValue(filterResult[0]);
                }
                this.handleErrors();
            }
        });
        this.filteredOptions = this.formControl.valueChanges.pipe(startWith(''), debounceTime(this.luxLookupDelay), map(value => this.getOptionLabel(value)), map(() => {
            const filterLabel = this.getOptionLabel(this.luxValue);
            return filterLabel ? this.filter(filterLabel) : this.luxOptions;
        }));
    }
    /**
     * @override errorMessageModifier - Modifikation der Fehlermeldung
     * @param value
     * @param errors
     */
    errorMessageModifier(value, errors) {
        if (errors['incorrect']) {
            return this.luxErrorMessageNotAnOption;
        }
        return undefined;
    }
    /**
     * Regelt die Darstellung der gewaehlten Option im Normalfall.
     * (Ausnahme: Focus-Verlust)
     * @param option
     * @returns string
     */
    displayFn(option) {
        return this.getOptionLabel(this.luxValue);
    }
    /**
     * Filtert das Options-Array nach dem filterTerm und
     * gibt das Ergebnis als Array zurueck.
     * @param filterTerm
     * @returns any[]
     */
    filter(filterTerm) {
        return this.luxOptions.filter(option => {
            const compareValue = this.getOptionLabel(option);
            return (compareValue
                .trim()
                .toLowerCase()
                .indexOf(filterTerm.trim().toLowerCase()) > -1);
        });
    }
    /**
     * Click-Event Handling
     * Selektiert den gesamten Text im Input, wenn selectAllOnClick = true ist.
     * @param clickEvent
     */
    onClick(clickEvent) {
        if (this.luxSelectAllOnClick) {
            clickEvent.target.setSelectionRange(0, clickEvent.target.value.length);
        }
    }
    /**
     * Gibt den darzustellenden Wert einer Option bzw.
     * die Option selbst (wenn string) wider.
     * @param option
     * @returns any
     */
    getOptionLabel(option) {
        if (typeof option === 'string') {
            return option;
        }
        else if (!option) {
            return '';
        }
        else {
            return option[this.luxOptionLabelProp];
        }
    }
    selected($event) {
        this.luxValue = $event.option.value;
    }
    handleErrors() {
        const errors = this.formControl ? this.formControl.errors : null;
        if (this.luxOptions.indexOf(this.luxValue) > -1 ||
            (!!errors && Object.keys(errors).length > 0 && errors['required'])) {
            this.handleOtherErrors(errors);
        }
        else {
            this.handleIncorrectError(errors);
        }
    }
    handleOtherErrors(errors) {
        if (errors && errors['incorrect']) {
            delete errors['incorrect'];
        }
        this.formControl.setErrors(errors && Object.keys(errors).length !== 0 ? errors : null);
    }
    handleIncorrectError(errors) {
        if (this.luxStrict && this.luxValue) {
            errors = errors ? errors : {};
            if (!errors['incorrect']) {
                errors['incorrect'] = true;
            }
            this.formControl.setErrors(errors);
        }
    }
    // region overridden methods
    notifyFormValueChanged(formValue) {
        this.selected$.next(formValue);
        this.luxValueChange.emit(formValue);
        if (formValue && formValue[this.luxOptionLabelProp]) {
            this.matInput.nativeElement.value = formValue[this.luxOptionLabelProp];
        }
    }
    triggerOutputPatternCheck() {
        this.checkOutputPatternViolation(this.luxValueChange.observers);
    }
    triggerInputPatternCheck(simpleChanges) {
        this.checkInputPatternViolation(simpleChanges.luxValue);
    }
};
LuxAutocompleteComponent.ctorParameters = () => [
    { type: ControlContainer, decorators: [{ type: Optional }] },
    { type: ChangeDetectorRef },
    { type: LuxConsoleService },
    { type: LuxComponentsConfigService }
];
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], LuxAutocompleteComponent.prototype, "luxPlaceholder", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], LuxAutocompleteComponent.prototype, "luxReadonly", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Array)
], LuxAutocompleteComponent.prototype, "luxOptions", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], LuxAutocompleteComponent.prototype, "luxOptionLabelProp", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Number)
], LuxAutocompleteComponent.prototype, "luxLookupDelay", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], LuxAutocompleteComponent.prototype, "luxErrorMessageNotAnOption", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], LuxAutocompleteComponent.prototype, "luxTagId", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], LuxAutocompleteComponent.prototype, "luxSelectAllOnClick", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Boolean)
], LuxAutocompleteComponent.prototype, "luxStrict", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], LuxAutocompleteComponent.prototype, "luxValueChange", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], LuxAutocompleteComponent.prototype, "luxOptionSelected", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], LuxAutocompleteComponent.prototype, "luxBlur", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], LuxAutocompleteComponent.prototype, "luxFocus", void 0);
tslib_1.__decorate([
    ViewChild('autoCompleteInput', { read: MatAutocompleteTrigger, static: false }),
    tslib_1.__metadata("design:type", MatAutocompleteTrigger)
], LuxAutocompleteComponent.prototype, "matAutoComplete", void 0);
tslib_1.__decorate([
    ViewChild('autoCompleteInput', { read: ElementRef, static: false }),
    tslib_1.__metadata("design:type", ElementRef)
], LuxAutocompleteComponent.prototype, "matInput", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object),
    tslib_1.__metadata("design:paramtypes", [Object])
], LuxAutocompleteComponent.prototype, "luxValue", null);
LuxAutocompleteComponent = tslib_1.__decorate([
    Component({
        selector: 'lux-autocomplete',
        template: "<lux-form-control [luxFormComponent]=\"this\" [formGroup]=\"formGroup\" *ngIf=\"formGroup\">\n  <div class=\"lux-input-row\">\n    <input\n      type=\"text\"\n      matInput\n      autocomplete=\"off\"\n      luxTagIdHandler\n      [luxTagId]=\"luxTagId\"\n      [formControl]=\"formControl\"\n      [placeholder]=\"luxPlaceholder\"\n      [matAutocomplete]=\"auto\"\n      [required]=\"luxRequired\"\n      (click)=\"onClick($event)\"\n      (blur)=\"luxBlur.emit($event)\"\n      (focus)=\"luxFocus.emit($event)\"\n      (focusin)=\"luxFocusIn.emit($event)\"\n      (focusout)=\"luxFocusOut.emit($event)\"\n      [id]=\"uid\"\n      [luxAriaDescribedby]=\"uid + '-error ' + uid + '-hint'\"\n      #autoCompleteInput\n    />\n    <mat-autocomplete\n      #auto=\"matAutocomplete\"\n      [class]=\"'lux-autocomplete-panel'\"\n      [displayWith]=\"displayFn.bind(this)\"\n      (optionSelected)=\"selected($event)\"\n    >\n      <mat-option *ngFor=\"let option of filteredOptions | async\" [value]=\"option\">\n        <ng-container *ngTemplateOutlet=\"optionTemplate; context: { $implicit: option }\"></ng-container>\n      </mat-option>\n    </mat-autocomplete>\n  </div>\n</lux-form-control>\n\n<ng-template #optionTemplate let-option>\n  <ng-container *ngIf=\"option[luxOptionLabelProp]; else showObjectTemplate\">\n    {{ option | luxRenderProperty: luxOptionLabelProp }}\n  </ng-container>\n  <ng-template #showObjectTemplate>\n    {{ option }}\n  </ng-template>\n</ng-template>\n",
        styles: ["::ng-deep .lux-autocomplete-panel mat-option:not(:last-of-type){margin-bottom:2px}"]
    }),
    tslib_1.__param(0, Optional()),
    tslib_1.__metadata("design:paramtypes", [ControlContainer,
        ChangeDetectorRef,
        LuxConsoleService,
        LuxComponentsConfigService])
], LuxAutocompleteComponent);
export { LuxAutocompleteComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHV4LWF1dG9jb21wbGV0ZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaWhrLWdmaS9sdXgtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbW9kdWxlcy9sdXgtZm9ybS9sdXgtYXV0b2NvbXBsZXRlL2x1eC1hdXRvY29tcGxldGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsYUFBYSxFQUNiLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUNOLFFBQVEsRUFDUixNQUFNLEVBQ04sYUFBYSxFQUNiLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNsRCxPQUFPLEVBQWdDLHNCQUFzQixFQUE0QixNQUFNLG1CQUFtQixDQUFDO0FBQ25ILE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxZQUFZLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3BGLE9BQU8sRUFBYyxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDdkUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sMkRBQTJELENBQUM7QUFPdkcsSUFBYSx3QkFBd0IsR0FBckMsTUFBYSx3QkFBeUIsU0FBUSxvQkFBb0I7SUFnQ2hFLFlBQ2MsZ0JBQWtDLEVBQzlDLEdBQXNCLEVBQ3RCLE1BQXlCLEVBQ2YsTUFBa0M7UUFFNUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFGbkMsV0FBTSxHQUFOLE1BQU0sQ0FBNEI7UUFuQ3RDLGNBQVMsR0FBdUIsSUFBSSxhQUFhLENBQU0sQ0FBQyxDQUFDLENBQUM7UUFJekQsbUJBQWMsR0FBVyxFQUFFLENBQUM7UUFFNUIsZUFBVSxHQUFVLEVBQUUsQ0FBQztRQUN2Qix1QkFBa0IsR0FBVyxPQUFPLENBQUM7UUFDckMsbUJBQWMsR0FBVyxHQUFHLENBQUM7UUFDN0IsK0JBQTBCLEdBQVcsa0RBQWtELENBQUM7UUFFeEYsd0JBQW1CLEdBQVksSUFBSSxDQUFDO1FBQ3BDLGNBQVMsR0FBWSxJQUFJLENBQUM7UUFFekIsbUJBQWMsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN2RCxzQkFBaUIsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUMxRCxZQUFPLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFDckQsYUFBUSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO0lBcUJoRSxDQUFDO0lBZkQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVRLElBQUksUUFBUSxDQUFDLEtBQVU7UUFDOUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBV0QsUUFBUTtRQUNOLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUVqQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzVELElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDbEIsSUFBSSxLQUFLLEtBQUssRUFBRSxFQUFFO29CQUNoQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNsQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDaEM7cUJBQU07b0JBQ0wsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEtBQUssTUFBTSxDQUFDLENBQUM7b0JBQ3hFLElBQUksY0FBYyxFQUFFO3dCQUNsQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO3dCQUM1QyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztxQkFDMUM7aUJBQ0Y7YUFDRjtpQkFBTTtnQkFDTCxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNqQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLENBQUMsZUFBZSxDQUFDLG1CQUFtQjthQUNyQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUN2QyxTQUFTLENBQUMsQ0FBQyxLQUErQixFQUFFLEVBQUU7WUFDN0MsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7Z0JBRXJFLElBQUksWUFBWSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQzdCLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUM1QztnQkFFRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7YUFDckI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVMLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUN2RCxTQUFTLENBQUMsRUFBRSxDQUFDLEVBQ2IsWUFBWSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsRUFDakMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUN4QyxHQUFHLENBQUMsR0FBRyxFQUFFO1lBQ1AsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdkQsT0FBTyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDbEUsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsb0JBQW9CLENBQUMsS0FBSyxFQUFFLE1BQU07UUFDaEMsSUFBSSxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDdkIsT0FBTyxJQUFJLENBQUMsMEJBQTBCLENBQUM7U0FDeEM7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxTQUFTLENBQUMsTUFBVztRQUNuQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILE1BQU0sQ0FBQyxVQUFlO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNqRCxPQUFPLENBQ0wsWUFBWTtpQkFDVCxJQUFJLEVBQUU7aUJBQ04sV0FBVyxFQUFFO2lCQUNiLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDakQsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxPQUFPLENBQUMsVUFBZTtRQUNyQixJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtZQUM1QixVQUFVLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUN4RTtJQUNILENBQUM7SUFFRDs7Ozs7T0FLRztJQUNILGNBQWMsQ0FBQyxNQUFXO1FBQ3hCLElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFO1lBQzlCLE9BQU8sTUFBTSxDQUFDO1NBQ2Y7YUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2xCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7YUFBTTtZQUNMLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3hDO0lBQ0gsQ0FBQztJQUVELFFBQVEsQ0FBQyxNQUFvQztRQUMzQyxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ3RDLENBQUM7SUFFTyxZQUFZO1FBQ2xCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDakUsSUFDRSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQ2xFO1lBQ0EsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2hDO2FBQU07WUFDTCxJQUFJLENBQUMsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDbkM7SUFDSCxDQUFDO0lBRU8saUJBQWlCLENBQUMsTUFBVztRQUNuQyxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDakMsT0FBTyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7U0FDNUI7UUFFRCxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUFFTyxvQkFBb0IsQ0FBQyxNQUFXO1FBQ3RDLElBQUksSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ25DLE1BQU0sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQzlCLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ3hCLE1BQU0sQ0FBQyxXQUFXLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDNUI7WUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNwQztJQUNILENBQUM7SUFFRCw0QkFBNEI7SUFDNUIsc0JBQXNCLENBQUMsU0FBYztRQUNuQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVwQyxJQUFJLFNBQVMsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEVBQUU7WUFDbkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUN4RTtJQUNILENBQUM7SUFFUyx5QkFBeUI7UUFDakMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDbEUsQ0FBQztJQUVTLHdCQUF3QixDQUFDLGFBQTRCO1FBQzdELElBQUksQ0FBQywwQkFBMEIsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDMUQsQ0FBQztDQUdGLENBQUE7O1lBaExpQyxnQkFBZ0IsdUJBQTdDLFFBQVE7WUFDSixpQkFBaUI7WUFDZCxpQkFBaUI7WUFDUCwwQkFBMEI7O0FBL0JyQztJQUFSLEtBQUssRUFBRTs7Z0VBQTZCO0FBQzVCO0lBQVIsS0FBSyxFQUFFOzs2REFBc0I7QUFDckI7SUFBUixLQUFLLEVBQUU7OzREQUF3QjtBQUN2QjtJQUFSLEtBQUssRUFBRTs7b0VBQXNDO0FBQ3JDO0lBQVIsS0FBSyxFQUFFOztnRUFBOEI7QUFDN0I7SUFBUixLQUFLLEVBQUU7OzRFQUF5RjtBQUN4RjtJQUFSLEtBQUssRUFBRTs7MERBQWtCO0FBQ2pCO0lBQVIsS0FBSyxFQUFFOztxRUFBcUM7QUFDcEM7SUFBUixLQUFLLEVBQUU7OzJEQUEyQjtBQUV6QjtJQUFULE1BQU0sRUFBRTtzQ0FBaUIsWUFBWTtnRUFBMkI7QUFDdkQ7SUFBVCxNQUFNLEVBQUU7c0NBQW9CLFlBQVk7bUVBQTJCO0FBQzFEO0lBQVQsTUFBTSxFQUFFO3NDQUFVLFlBQVk7eURBQWdDO0FBQ3JEO0lBQVQsTUFBTSxFQUFFO3NDQUFXLFlBQVk7MERBQWdDO0FBR2hFO0lBREMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLEVBQUUsSUFBSSxFQUFFLHNCQUFzQixFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQztzQ0FDL0Qsc0JBQXNCO2lFQUFDO0FBQzZCO0lBQXBFLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDO3NDQUFXLFVBQVU7MERBQUM7QUFNakY7SUFBUixLQUFLLEVBQUU7Ozt3REFFUDtBQTlCVSx3QkFBd0I7SUFMcEMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLGtCQUFrQjtRQUM1Qiw2OUNBQWdEOztLQUVqRCxDQUFDO0lBa0NHLG1CQUFBLFFBQVEsRUFBRSxDQUFBOzZDQUFtQixnQkFBZ0I7UUFDekMsaUJBQWlCO1FBQ2QsaUJBQWlCO1FBQ1AsMEJBQTBCO0dBcENuQyx3QkFBd0IsQ0FpTnBDO1NBak5ZLHdCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyVmlld0luaXQsXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uSW5pdCxcbiAgT3B0aW9uYWwsXG4gIE91dHB1dCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udHJvbENvbnRhaW5lciB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IE1hdEF1dG9jb21wbGV0ZVNlbGVjdGVkRXZlbnQsIE1hdEF1dG9jb21wbGV0ZVRyaWdnZXIsIE1hdE9wdGlvblNlbGVjdGlvbkNoYW5nZSB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcbmltcG9ydCB7IEx1eEZvcm1Db21wb25lbnRCYXNlIH0gZnJvbSAnLi4vbHV4LWZvcm0tbW9kZWwvbHV4LWZvcm0tY29tcG9uZW50LWJhc2UuY2xhc3MnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBzdGFydFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBMdXhDb25zb2xlU2VydmljZSB9IGZyb20gJy4uLy4uL2x1eC11dGlsL2x1eC1jb25zb2xlLnNlcnZpY2UnO1xuaW1wb3J0IHsgTHV4Q29tcG9uZW50c0NvbmZpZ1NlcnZpY2UgfSBmcm9tICcuLi8uLi9sdXgtY29tcG9uZW50cy1jb25maWcvbHV4LWNvbXBvbmVudHMtY29uZmlnLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdsdXgtYXV0b2NvbXBsZXRlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2x1eC1hdXRvY29tcGxldGUuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9sdXgtYXV0b2NvbXBsZXRlLmNvbXBvbmVudC5zY3NzJ11cbn0pXG5leHBvcnQgY2xhc3MgTHV4QXV0b2NvbXBsZXRlQ29tcG9uZW50IGV4dGVuZHMgTHV4Rm9ybUNvbXBvbmVudEJhc2UgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQge1xuICBwcml2YXRlIHNlbGVjdGVkJDogUmVwbGF5U3ViamVjdDxhbnk+ID0gbmV3IFJlcGxheVN1YmplY3Q8YW55PigxKTtcblxuICBmaWx0ZXJlZE9wdGlvbnM6IE9ic2VydmFibGU8YW55PjtcblxuICBASW5wdXQoKSBsdXhQbGFjZWhvbGRlcjogc3RyaW5nID0gJyc7XG4gIEBJbnB1dCgpIGx1eFJlYWRvbmx5OiBib29sZWFuO1xuICBASW5wdXQoKSBsdXhPcHRpb25zOiBhbnlbXSA9IFtdO1xuICBASW5wdXQoKSBsdXhPcHRpb25MYWJlbFByb3A6IHN0cmluZyA9ICdsYWJlbCc7XG4gIEBJbnB1dCgpIGx1eExvb2t1cERlbGF5OiBudW1iZXIgPSA1MDA7XG4gIEBJbnB1dCgpIGx1eEVycm9yTWVzc2FnZU5vdEFuT3B0aW9uOiBzdHJpbmcgPSAnRGVyIGVpbmdlZ2ViZW5lIFdlcnQgaXN0IG5pY2h0IFRlaWwgZGVyIEF1c3dhaGwuJztcbiAgQElucHV0KCkgbHV4VGFnSWQ6IHN0cmluZztcbiAgQElucHV0KCkgbHV4U2VsZWN0QWxsT25DbGljazogYm9vbGVhbiA9IHRydWU7XG4gIEBJbnB1dCgpIGx1eFN0cmljdDogYm9vbGVhbiA9IHRydWU7XG5cbiAgQE91dHB1dCgpIGx1eFZhbHVlQ2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIGx1eE9wdGlvblNlbGVjdGVkOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIGx1eEJsdXI6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoKSBsdXhGb2N1czogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAVmlld0NoaWxkKCdhdXRvQ29tcGxldGVJbnB1dCcsIHsgcmVhZDogTWF0QXV0b2NvbXBsZXRlVHJpZ2dlciwgc3RhdGljOiBmYWxzZSB9KVxuICBtYXRBdXRvQ29tcGxldGU6IE1hdEF1dG9jb21wbGV0ZVRyaWdnZXI7XG4gIEBWaWV3Q2hpbGQoJ2F1dG9Db21wbGV0ZUlucHV0JywgeyByZWFkOiBFbGVtZW50UmVmLCBzdGF0aWM6IGZhbHNlIH0pIG1hdElucHV0OiBFbGVtZW50UmVmO1xuXG4gIGdldCBsdXhWYWx1ZSgpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLmdldFZhbHVlKCk7XG4gIH1cblxuICBASW5wdXQoKSBzZXQgbHV4VmFsdWUodmFsdWU6IGFueSkge1xuICAgIHRoaXMuc2V0VmFsdWUodmFsdWUpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKCkgY29udHJvbENvbnRhaW5lcjogQ29udHJvbENvbnRhaW5lcixcbiAgICBjZHI6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIGxvZ2dlcjogTHV4Q29uc29sZVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNvbmZpZzogTHV4Q29tcG9uZW50c0NvbmZpZ1NlcnZpY2VcbiAgKSB7XG4gICAgc3VwZXIoY29udHJvbENvbnRhaW5lciwgY2RyLCBsb2dnZXIsIGNvbmZpZyk7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICBzdXBlci5uZ09uSW5pdCgpO1xuXG4gICAgdGhpcy5zZWxlY3RlZCQucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKS5zdWJzY3JpYmUodmFsdWUgPT4ge1xuICAgICAgaWYgKHRoaXMubHV4U3RyaWN0KSB7XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gJycpIHtcbiAgICAgICAgICB0aGlzLmx1eE9wdGlvblNlbGVjdGVkLmVtaXQobnVsbCk7XG4gICAgICAgICAgdGhpcy5sdXhWYWx1ZUNoYW5nZS5lbWl0KG51bGwpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHNlbGVjdGVkT3B0aW9uID0gdGhpcy5sdXhPcHRpb25zLmZpbmQob3B0aW9uID0+IHZhbHVlID09PSBvcHRpb24pO1xuICAgICAgICAgIGlmIChzZWxlY3RlZE9wdGlvbikge1xuICAgICAgICAgICAgdGhpcy5sdXhPcHRpb25TZWxlY3RlZC5lbWl0KHNlbGVjdGVkT3B0aW9uKTtcbiAgICAgICAgICAgIHRoaXMubHV4VmFsdWVDaGFuZ2UuZW1pdChzZWxlY3RlZE9wdGlvbik7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmx1eE9wdGlvblNlbGVjdGVkLmVtaXQodmFsdWUpO1xuICAgICAgICB0aGlzLmx1eFZhbHVlQ2hhbmdlLmVtaXQodmFsdWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRoaXMubWF0QXV0b0NvbXBsZXRlLnBhbmVsQ2xvc2luZ0FjdGlvbnNcbiAgICAgIC5waXBlKGRlYm91bmNlVGltZSh0aGlzLmx1eExvb2t1cERlbGF5KSlcbiAgICAgIC5zdWJzY3JpYmUoKHZhbHVlOiBNYXRPcHRpb25TZWxlY3Rpb25DaGFuZ2UpID0+IHtcbiAgICAgICAgaWYgKHRoaXMubHV4U3RyaWN0KSB7XG4gICAgICAgICAgY29uc3QgZmlsdGVyUmVzdWx0ID0gdGhpcy5maWx0ZXIodGhpcy5nZXRPcHRpb25MYWJlbCh0aGlzLmx1eFZhbHVlKSk7XG5cbiAgICAgICAgICBpZiAoZmlsdGVyUmVzdWx0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgdGhpcy5mb3JtQ29udHJvbC5zZXRWYWx1ZShmaWx0ZXJSZXN1bHRbMF0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuaGFuZGxlRXJyb3JzKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuXG4gICAgdGhpcy5maWx0ZXJlZE9wdGlvbnMgPSB0aGlzLmZvcm1Db250cm9sLnZhbHVlQ2hhbmdlcy5waXBlKFxuICAgICAgc3RhcnRXaXRoKCcnKSxcbiAgICAgIGRlYm91bmNlVGltZSh0aGlzLmx1eExvb2t1cERlbGF5KSxcbiAgICAgIG1hcCh2YWx1ZSA9PiB0aGlzLmdldE9wdGlvbkxhYmVsKHZhbHVlKSksXG4gICAgICBtYXAoKCkgPT4ge1xuICAgICAgICBjb25zdCBmaWx0ZXJMYWJlbCA9IHRoaXMuZ2V0T3B0aW9uTGFiZWwodGhpcy5sdXhWYWx1ZSk7XG4gICAgICAgIHJldHVybiBmaWx0ZXJMYWJlbCA/IHRoaXMuZmlsdGVyKGZpbHRlckxhYmVsKSA6IHRoaXMubHV4T3B0aW9ucztcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAb3ZlcnJpZGUgZXJyb3JNZXNzYWdlTW9kaWZpZXIgLSBNb2RpZmlrYXRpb24gZGVyIEZlaGxlcm1lbGR1bmdcbiAgICogQHBhcmFtIHZhbHVlXG4gICAqIEBwYXJhbSBlcnJvcnNcbiAgICovXG4gIGVycm9yTWVzc2FnZU1vZGlmaWVyKHZhbHVlLCBlcnJvcnMpIHtcbiAgICBpZiAoZXJyb3JzWydpbmNvcnJlY3QnXSkge1xuICAgICAgcmV0dXJuIHRoaXMubHV4RXJyb3JNZXNzYWdlTm90QW5PcHRpb247XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICAvKipcbiAgICogUmVnZWx0IGRpZSBEYXJzdGVsbHVuZyBkZXIgZ2V3YWVobHRlbiBPcHRpb24gaW0gTm9ybWFsZmFsbC5cbiAgICogKEF1c25haG1lOiBGb2N1cy1WZXJsdXN0KVxuICAgKiBAcGFyYW0gb3B0aW9uXG4gICAqIEByZXR1cm5zIHN0cmluZ1xuICAgKi9cbiAgZGlzcGxheUZuKG9wdGlvbjogYW55KTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5nZXRPcHRpb25MYWJlbCh0aGlzLmx1eFZhbHVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBGaWx0ZXJ0IGRhcyBPcHRpb25zLUFycmF5IG5hY2ggZGVtIGZpbHRlclRlcm0gdW5kXG4gICAqIGdpYnQgZGFzIEVyZ2VibmlzIGFscyBBcnJheSB6dXJ1ZWNrLlxuICAgKiBAcGFyYW0gZmlsdGVyVGVybVxuICAgKiBAcmV0dXJucyBhbnlbXVxuICAgKi9cbiAgZmlsdGVyKGZpbHRlclRlcm06IGFueSkge1xuICAgIHJldHVybiB0aGlzLmx1eE9wdGlvbnMuZmlsdGVyKG9wdGlvbiA9PiB7XG4gICAgICBjb25zdCBjb21wYXJlVmFsdWUgPSB0aGlzLmdldE9wdGlvbkxhYmVsKG9wdGlvbik7XG4gICAgICByZXR1cm4gKFxuICAgICAgICBjb21wYXJlVmFsdWVcbiAgICAgICAgICAudHJpbSgpXG4gICAgICAgICAgLnRvTG93ZXJDYXNlKClcbiAgICAgICAgICAuaW5kZXhPZihmaWx0ZXJUZXJtLnRyaW0oKS50b0xvd2VyQ2FzZSgpKSA+IC0xXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENsaWNrLUV2ZW50IEhhbmRsaW5nXG4gICAqIFNlbGVrdGllcnQgZGVuIGdlc2FtdGVuIFRleHQgaW0gSW5wdXQsIHdlbm4gc2VsZWN0QWxsT25DbGljayA9IHRydWUgaXN0LlxuICAgKiBAcGFyYW0gY2xpY2tFdmVudFxuICAgKi9cbiAgb25DbGljayhjbGlja0V2ZW50OiBhbnkpIHtcbiAgICBpZiAodGhpcy5sdXhTZWxlY3RBbGxPbkNsaWNrKSB7XG4gICAgICBjbGlja0V2ZW50LnRhcmdldC5zZXRTZWxlY3Rpb25SYW5nZSgwLCBjbGlja0V2ZW50LnRhcmdldC52YWx1ZS5sZW5ndGgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHaWJ0IGRlbiBkYXJ6dXN0ZWxsZW5kZW4gV2VydCBlaW5lciBPcHRpb24gYnp3LlxuICAgKiBkaWUgT3B0aW9uIHNlbGJzdCAod2VubiBzdHJpbmcpIHdpZGVyLlxuICAgKiBAcGFyYW0gb3B0aW9uXG4gICAqIEByZXR1cm5zIGFueVxuICAgKi9cbiAgZ2V0T3B0aW9uTGFiZWwob3B0aW9uOiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIG9wdGlvbiA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBvcHRpb247XG4gICAgfSBlbHNlIGlmICghb3B0aW9uKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBvcHRpb25bdGhpcy5sdXhPcHRpb25MYWJlbFByb3BdO1xuICAgIH1cbiAgfVxuXG4gIHNlbGVjdGVkKCRldmVudDogTWF0QXV0b2NvbXBsZXRlU2VsZWN0ZWRFdmVudCkge1xuICAgIHRoaXMubHV4VmFsdWUgPSAkZXZlbnQub3B0aW9uLnZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVFcnJvcnMoKSB7XG4gICAgY29uc3QgZXJyb3JzID0gdGhpcy5mb3JtQ29udHJvbCA/IHRoaXMuZm9ybUNvbnRyb2wuZXJyb3JzIDogbnVsbDtcbiAgICBpZiAoXG4gICAgICB0aGlzLmx1eE9wdGlvbnMuaW5kZXhPZih0aGlzLmx1eFZhbHVlKSA+IC0xIHx8XG4gICAgICAoISFlcnJvcnMgJiYgT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGggPiAwICYmIGVycm9yc1sncmVxdWlyZWQnXSlcbiAgICApIHtcbiAgICAgIHRoaXMuaGFuZGxlT3RoZXJFcnJvcnMoZXJyb3JzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5oYW5kbGVJbmNvcnJlY3RFcnJvcihlcnJvcnMpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlT3RoZXJFcnJvcnMoZXJyb3JzOiBhbnkpIHtcbiAgICBpZiAoZXJyb3JzICYmIGVycm9yc1snaW5jb3JyZWN0J10pIHtcbiAgICAgIGRlbGV0ZSBlcnJvcnNbJ2luY29ycmVjdCddO1xuICAgIH1cblxuICAgIHRoaXMuZm9ybUNvbnRyb2wuc2V0RXJyb3JzKGVycm9ycyAmJiBPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCAhPT0gMCA/IGVycm9ycyA6IG51bGwpO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVJbmNvcnJlY3RFcnJvcihlcnJvcnM6IGFueSkge1xuICAgIGlmICh0aGlzLmx1eFN0cmljdCAmJiB0aGlzLmx1eFZhbHVlKSB7XG4gICAgICBlcnJvcnMgPSBlcnJvcnMgPyBlcnJvcnMgOiB7fTtcbiAgICAgIGlmICghZXJyb3JzWydpbmNvcnJlY3QnXSkge1xuICAgICAgICBlcnJvcnNbJ2luY29ycmVjdCddID0gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZm9ybUNvbnRyb2wuc2V0RXJyb3JzKGVycm9ycyk7XG4gICAgfVxuICB9XG5cbiAgLy8gcmVnaW9uIG92ZXJyaWRkZW4gbWV0aG9kc1xuICBub3RpZnlGb3JtVmFsdWVDaGFuZ2VkKGZvcm1WYWx1ZTogYW55KSB7XG4gICAgdGhpcy5zZWxlY3RlZCQubmV4dChmb3JtVmFsdWUpO1xuICAgIHRoaXMubHV4VmFsdWVDaGFuZ2UuZW1pdChmb3JtVmFsdWUpO1xuXG4gICAgaWYgKGZvcm1WYWx1ZSAmJiBmb3JtVmFsdWVbdGhpcy5sdXhPcHRpb25MYWJlbFByb3BdKSB7XG4gICAgICB0aGlzLm1hdElucHV0Lm5hdGl2ZUVsZW1lbnQudmFsdWUgPSBmb3JtVmFsdWVbdGhpcy5sdXhPcHRpb25MYWJlbFByb3BdO1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCB0cmlnZ2VyT3V0cHV0UGF0dGVybkNoZWNrKCkge1xuICAgIHRoaXMuY2hlY2tPdXRwdXRQYXR0ZXJuVmlvbGF0aW9uKHRoaXMubHV4VmFsdWVDaGFuZ2Uub2JzZXJ2ZXJzKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB0cmlnZ2VySW5wdXRQYXR0ZXJuQ2hlY2soc2ltcGxlQ2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIHRoaXMuY2hlY2tJbnB1dFBhdHRlcm5WaW9sYXRpb24oc2ltcGxlQ2hhbmdlcy5sdXhWYWx1ZSk7XG4gIH1cblxuICAvLyBlbmRyZWdpb25cbn1cbiJdfQ==