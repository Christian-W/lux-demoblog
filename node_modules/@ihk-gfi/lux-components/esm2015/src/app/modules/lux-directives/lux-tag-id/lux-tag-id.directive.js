import * as tslib_1 from "tslib";
var LuxTagIdDirective_1;
import { AfterViewInit, Directive, ElementRef, Input, OnDestroy, OnInit, Renderer2 } from '@angular/core';
import { LuxUtil } from '../../lux-util/lux-util';
import { LuxComponentsConfigService } from '../../lux-components-config/lux-components-config.service';
import { luxFormControlSelektor } from '../../lux-form/lux-form-control/lux-form-control.component';
let LuxTagIdDirective = LuxTagIdDirective_1 = class LuxTagIdDirective {
    constructor(elementRef, renderer, componentsConfigService) {
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.componentsConfigService = componentsConfigService;
    }
    ngOnInit() {
        this.configSubscription = this.componentsConfigService.config.subscribe((newConfig) => {
            this.generateLuxTagIds = newConfig.generateLuxTagIds;
        });
    }
    ngAfterViewInit() {
        if (this.generateLuxTagIds) {
            const luxComponent = this.findLuxComponent(this.elementRef.nativeElement);
            if (luxComponent) {
                let newTagId = this.luxTagId;
                if (!newTagId) {
                    newTagId = this.getLuxTagId(luxComponent);
                }
                if (newTagId) {
                    newTagId = this.mergeTagIds(this.getLuxTagIdParent(luxComponent.parentElement, ''), luxComponent.nodeName + LuxTagIdDirective_1.sepComponent + newTagId);
                    newTagId = newTagId.toLowerCase();
                    this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                }
                else {
                    let usedLabel = false;
                    if (luxComponent.getAttribute('luxLabel')) {
                        newTagId = this.mergeTagIds(luxComponent.getAttribute('luxLabel'), newTagId);
                        newTagId = newTagId.toLowerCase();
                        this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                        usedLabel = true;
                    }
                    else if (luxComponent.getAttribute('ng-reflect-lux-label')) {
                        newTagId = this.mergeTagIds(luxComponent.getAttribute('ng-reflect-lux-label'), newTagId);
                        newTagId = newTagId.toLowerCase();
                        this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                        usedLabel = true;
                    }
                    else if (luxComponent.getAttribute('ng-reflect-label')) {
                        newTagId = this.mergeTagIds(luxComponent.getAttribute('ng-reflect-label'), newTagId);
                        newTagId = newTagId.toLowerCase();
                        this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                        usedLabel = true;
                    }
                    else if (luxComponent.getElementsByClassName('lux-form-label')[0]) {
                        newTagId = this.mergeTagIds(luxComponent.getElementsByClassName('lux-form-label')[0].textContent.trim(), newTagId);
                        newTagId = newTagId.toLowerCase();
                        this.renderer.setAttribute(luxComponent, LuxTagIdDirective_1.luxTagIdAttrName, newTagId);
                        usedLabel = true;
                    }
                    if (!usedLabel) {
                        console.warn('Dem Tag "' +
                            this.getNodeName(luxComponent) +
                            '(' +
                            this.getParentPath(luxComponent.parentElement, '') +
                            ')' +
                            '" fehlt das luxTagId-Attribut. Dieses Attribut wird für die automatischen Tests benötigt.');
                    }
                }
            }
        }
    }
    ngOnDestroy() {
        this.configSubscription.unsubscribe();
    }
    getParentPath(element, currentTagId) {
        if (element && element.parentElement) {
            return this.getParentPath(element.parentElement, currentTagId + '.' + this.getNodeName(element.parentElement));
        }
        return currentTagId;
    }
    getLuxTagIdParent(element, currentTagId) {
        if (element) {
            let newTagId = currentTagId;
            if (element.hasAttribute('luxTagId')) {
                newTagId = this.mergeTagIds('luxTagId', newTagId);
            }
            else if (element.hasAttribute(LuxTagIdDirective_1.luxTagIdAttrName)) {
                newTagId = this.mergeTagIds(element.getAttribute(LuxTagIdDirective_1.luxTagIdAttrName), newTagId);
            }
            else if (element.hasAttribute('luxcontrolbinding')) {
                newTagId = this.mergeTagIds(element.getAttribute('luxcontrolbinding'), newTagId);
            }
            else if (element.hasAttribute('formgroupname')) {
                newTagId = this.mergeTagIds('formgroup' + LuxTagIdDirective_1.sepComponent + element.getAttribute('formgroupname'), newTagId);
            }
            return this.getLuxTagIdParent(element.parentElement, newTagId);
        }
        return currentTagId;
    }
    mergeTagIds(tagId1, tagId2) {
        let tagId;
        if (!LuxUtil.isEmpty(tagId1) && !LuxUtil.isEmpty(tagId2)) {
            tagId = tagId1 + LuxTagIdDirective_1.sepParent + tagId2;
        }
        else if (!LuxUtil.isEmpty(tagId1) && LuxUtil.isEmpty(tagId2)) {
            tagId = tagId1;
        }
        else if (LuxUtil.isEmpty(tagId1) && !LuxUtil.isEmpty(tagId2)) {
            tagId = tagId2;
        }
        else {
            tagId = '';
        }
        return tagId;
    }
    getLuxTagId(element) {
        let newId = '';
        if (element) {
            if (element.hasAttribute('luxTagId')) {
                newId = element.getAttribute('luxTagId');
            }
            else if (element.hasAttribute(LuxTagIdDirective_1.luxTagIdAttrName)) {
                newId = element.getAttribute(LuxTagIdDirective_1.luxTagIdAttrName);
            }
            else if (element.hasAttribute('luxcontrolbinding')) {
                newId = element.getAttribute('luxcontrolbinding');
            }
            else if (element.hasAttribute('formgroupname')) {
                newId = element.getAttribute('formgroupname');
            }
        }
        return newId;
    }
    findLuxComponent(element) {
        if (element) {
            const nodeName = this.getNodeName(element);
            if (nodeName && nodeName.startsWith('lux-'.toUpperCase()) && nodeName !== luxFormControlSelektor.toUpperCase()) {
                return element;
            }
            else {
                return this.findLuxComponent(element.parentElement);
            }
        }
        return null;
    }
    getNodeName(element) {
        return element && element.nodeName ? element.nodeName : '';
    }
};
LuxTagIdDirective.luxTagIdAttrName = 'data-luxtagid';
LuxTagIdDirective.sepParent = '.';
LuxTagIdDirective.sepComponent = '#';
LuxTagIdDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: LuxComponentsConfigService }
];
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], LuxTagIdDirective.prototype, "luxTagId", void 0);
LuxTagIdDirective = LuxTagIdDirective_1 = tslib_1.__decorate([
    Directive({
        selector: '[luxTagIdHandler]'
    }),
    tslib_1.__metadata("design:paramtypes", [ElementRef,
        Renderer2,
        LuxComponentsConfigService])
], LuxTagIdDirective);
export { LuxTagIdDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHV4LXRhZy1pZC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaWhrLWdmaS9sdXgtY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbW9kdWxlcy9sdXgtZGlyZWN0aXZlcy9sdXgtdGFnLWlkL2x1eC10YWctaWQuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDbEQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sMkRBQTJELENBQUM7QUFHdkcsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNERBQTRELENBQUM7QUFLcEcsSUFBYSxpQkFBaUIseUJBQTlCLE1BQWEsaUJBQWlCO0lBVzVCLFlBQ1UsVUFBc0IsRUFDdEIsUUFBbUIsRUFDcEIsdUJBQW1EO1FBRmxELGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUNwQiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQTRCO0lBQ3pELENBQUM7SUFFSixRQUFRO1FBQ04sSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUNyRSxDQUFDLFNBQXdDLEVBQUUsRUFBRTtZQUMzQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsU0FBUyxDQUFDLGlCQUFpQixDQUFDO1FBQ3ZELENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELGVBQWU7UUFDYixJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUMxQixNQUFNLFlBQVksR0FBWSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMs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T0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzdELENBQUM7Q0FDRixDQUFBO0FBN0t3QixrQ0FBZ0IsR0FBVyxlQUFlLENBQUM7QUFDM0MsMkJBQVMsR0FBVyxHQUFHLENBQUM7QUFDeEIsOEJBQVksR0FBVyxHQUFHLENBQUM7O1lBUzVCLFVBQVU7WUFDWixTQUFTO1lBQ0ssMEJBQTBCOztBQVBuRDtJQUFSLEtBQUssRUFBRTs7bURBQWtCO0FBUGYsaUJBQWlCO0lBSDdCLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSxtQkFBbUI7S0FDOUIsQ0FBQzs2Q0Fhc0IsVUFBVTtRQUNaLFNBQVM7UUFDSywwQkFBMEI7R0FkakQsaUJBQWlCLENBOEs3QjtTQTlLWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIElucHV0LCBPbkRlc3Ryb3ksIE9uSW5pdCwgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBMdXhVdGlsIH0gZnJvbSAnLi4vLi4vbHV4LXV0aWwvbHV4LXV0aWwnO1xuaW1wb3J0IHsgTHV4Q29tcG9uZW50c0NvbmZpZ1NlcnZpY2UgfSBmcm9tICcuLi8uLi9sdXgtY29tcG9uZW50cy1jb25maWcvbHV4LWNvbXBvbmVudHMtY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHsgTHV4Q29tcG9uZW50c0NvbmZpZ1BhcmFtZXRlcnMgfSBmcm9tICcuLi8uLi9sdXgtY29tcG9uZW50cy1jb25maWcvbHV4LWNvbXBvbmVudHMtY29uZmlnLXBhcmFtZXRlcnMuaW50ZXJmYWNlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbHV4Rm9ybUNvbnRyb2xTZWxla3RvciB9IGZyb20gJy4uLy4uL2x1eC1mb3JtL2x1eC1mb3JtLWNvbnRyb2wvbHV4LWZvcm0tY29udHJvbC5jb21wb25lbnQnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbbHV4VGFnSWRIYW5kbGVyXSdcbn0pXG5leHBvcnQgY2xhc3MgTHV4VGFnSWREaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgbHV4VGFnSWRBdHRyTmFtZTogc3RyaW5nID0gJ2RhdGEtbHV4dGFnaWQnO1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IHNlcFBhcmVudDogc3RyaW5nID0gJy4nO1xuICBwdWJsaWMgc3RhdGljIHJlYWRvbmx5IHNlcENvbXBvbmVudDogc3RyaW5nID0gJyMnO1xuXG4gIHByaXZhdGUgY29uZmlnU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgQElucHV0KCkgbHV4VGFnSWQ6IHN0cmluZztcblxuICBnZW5lcmF0ZUx1eFRhZ0lkczogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHB1YmxpYyBjb21wb25lbnRzQ29uZmlnU2VydmljZTogTHV4Q29tcG9uZW50c0NvbmZpZ1NlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuY29uZmlnU3Vic2NyaXB0aW9uID0gdGhpcy5jb21wb25lbnRzQ29uZmlnU2VydmljZS5jb25maWcuc3Vic2NyaWJlKFxuICAgICAgKG5ld0NvbmZpZzogTHV4Q29tcG9uZW50c0NvbmZpZ1BhcmFtZXRlcnMpID0+IHtcbiAgICAgICAgdGhpcy5nZW5lcmF0ZUx1eFRhZ0lkcyA9IG5ld0NvbmZpZy5nZW5lcmF0ZUx1eFRhZ0lkcztcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGlmICh0aGlzLmdlbmVyYXRlTHV4VGFnSWRzKSB7XG4gICAgICBjb25zdCBsdXhDb21wb25lbnQ6IEVsZW1lbnQgPSB0aGlzLmZpbmRMdXhDb21wb25lbnQodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpO1xuXG4gICAgICBpZiAobHV4Q29tcG9uZW50KSB7XG4gICAgICAgIGxldCBuZXdUYWdJZCA9IHRoaXMubHV4VGFnSWQ7XG5cbiAgICAgICAgaWYgKCFuZXdUYWdJZCkge1xuICAgICAgICAgIG5ld1RhZ0lkID0gdGhpcy5nZXRMdXhUYWdJZChsdXhDb21wb25lbnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5ld1RhZ0lkKSB7XG4gICAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKFxuICAgICAgICAgICAgdGhpcy5nZXRMdXhUYWdJZFBhcmVudChsdXhDb21wb25lbnQucGFyZW50RWxlbWVudCwgJycpLFxuICAgICAgICAgICAgbHV4Q29tcG9uZW50Lm5vZGVOYW1lICsgTHV4VGFnSWREaXJlY3RpdmUuc2VwQ29tcG9uZW50ICsgbmV3VGFnSWRcbiAgICAgICAgICApO1xuICAgICAgICAgIG5ld1RhZ0lkID0gbmV3VGFnSWQudG9Mb3dlckNhc2UoKTtcblxuICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKGx1eENvbXBvbmVudCwgTHV4VGFnSWREaXJlY3RpdmUubHV4VGFnSWRBdHRyTmFtZSwgbmV3VGFnSWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxldCB1c2VkTGFiZWwgPSBmYWxzZTtcbiAgICAgICAgICBpZiAobHV4Q29tcG9uZW50LmdldEF0dHJpYnV0ZSgnbHV4TGFiZWwnKSkge1xuICAgICAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKGx1eENvbXBvbmVudC5nZXRBdHRyaWJ1dGUoJ2x1eExhYmVsJyksIG5ld1RhZ0lkKTtcbiAgICAgICAgICAgIG5ld1RhZ0lkID0gbmV3VGFnSWQudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKGx1eENvbXBvbmVudCwgTHV4VGFnSWREaXJlY3RpdmUubHV4VGFnSWRBdHRyTmFtZSwgbmV3VGFnSWQpO1xuXG4gICAgICAgICAgICB1c2VkTGFiZWwgPSB0cnVlO1xuICAgICAgICAgIH0gZWxzZSBpZiAobHV4Q29tcG9uZW50LmdldEF0dHJpYnV0ZSgnbmctcmVmbGVjdC1sdXgtbGFiZWwnKSkge1xuICAgICAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKGx1eENvbXBvbmVudC5nZXRBdHRyaWJ1dGUoJ25nLXJlZmxlY3QtbHV4LWxhYmVsJyksIG5ld1RhZ0lkKTtcbiAgICAgICAgICAgIG5ld1RhZ0lkID0gbmV3VGFnSWQudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKGx1eENvbXBvbmVudCwgTHV4VGFnSWREaXJlY3RpdmUubHV4VGFnSWRBdHRyTmFtZSwgbmV3VGFnSWQpO1xuXG4gICAgICAgICAgICB1c2VkTGFiZWwgPSB0cnVlO1xuICAgICAgICAgIH0gZWxzZSBpZiAobHV4Q29tcG9uZW50LmdldEF0dHJpYnV0ZSgnbmctcmVmbGVjdC1sYWJlbCcpKSB7XG4gICAgICAgICAgICBuZXdUYWdJZCA9IHRoaXMubWVyZ2VUYWdJZHMobHV4Q29tcG9uZW50LmdldEF0dHJpYnV0ZSgnbmctcmVmbGVjdC1sYWJlbCcpLCBuZXdUYWdJZCk7XG4gICAgICAgICAgICBuZXdUYWdJZCA9IG5ld1RhZ0lkLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShsdXhDb21wb25lbnQsIEx1eFRhZ0lkRGlyZWN0aXZlLmx1eFRhZ0lkQXR0ck5hbWUsIG5ld1RhZ0lkKTtcblxuICAgICAgICAgICAgdXNlZExhYmVsID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGx1eENvbXBvbmVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdsdXgtZm9ybS1sYWJlbCcpWzBdKSB7XG4gICAgICAgICAgICBuZXdUYWdJZCA9IHRoaXMubWVyZ2VUYWdJZHMoXG4gICAgICAgICAgICAgIGx1eENvbXBvbmVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdsdXgtZm9ybS1sYWJlbCcpWzBdLnRleHRDb250ZW50LnRyaW0oKSxcbiAgICAgICAgICAgICAgbmV3VGFnSWRcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBuZXdUYWdJZCA9IG5ld1RhZ0lkLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShsdXhDb21wb25lbnQsIEx1eFRhZ0lkRGlyZWN0aXZlLmx1eFRhZ0lkQXR0ck5hbWUsIG5ld1RhZ0lkKTtcblxuICAgICAgICAgICAgdXNlZExhYmVsID0gdHJ1ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoIXVzZWRMYWJlbCkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgICAgICAnRGVtIFRhZyBcIicgK1xuICAgICAgICAgICAgICAgIHRoaXMuZ2V0Tm9kZU5hbWUobHV4Q29tcG9uZW50KSArXG4gICAgICAgICAgICAgICAgJygnICtcbiAgICAgICAgICAgICAgICB0aGlzLmdldFBhcmVudFBhdGgobHV4Q29tcG9uZW50LnBhcmVudEVsZW1lbnQsICcnKSArXG4gICAgICAgICAgICAgICAgJyknICtcbiAgICAgICAgICAgICAgICAnXCIgZmVobHQgZGFzIGx1eFRhZ0lkLUF0dHJpYnV0LiBEaWVzZXMgQXR0cmlidXQgd2lyZCBmw7xyIGRpZSBhdXRvbWF0aXNjaGVuIFRlc3RzIGJlbsO2dGlndC4nXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuY29uZmlnU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcml2YXRlIGdldFBhcmVudFBhdGgoZWxlbWVudDogRWxlbWVudCwgY3VycmVudFRhZ0lkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmIChlbGVtZW50ICYmIGVsZW1lbnQucGFyZW50RWxlbWVudCkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFyZW50UGF0aChlbGVtZW50LnBhcmVudEVsZW1lbnQsIGN1cnJlbnRUYWdJZCArICcuJyArIHRoaXMuZ2V0Tm9kZU5hbWUoZWxlbWVudC5wYXJlbnRFbGVtZW50KSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGN1cnJlbnRUYWdJZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0THV4VGFnSWRQYXJlbnQoZWxlbWVudDogRWxlbWVudCwgY3VycmVudFRhZ0lkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmIChlbGVtZW50KSB7XG4gICAgICBsZXQgbmV3VGFnSWQ6IHN0cmluZyA9IGN1cnJlbnRUYWdJZDtcbiAgICAgIGlmIChlbGVtZW50Lmhhc0F0dHJpYnV0ZSgnbHV4VGFnSWQnKSkge1xuICAgICAgICBuZXdUYWdJZCA9IHRoaXMubWVyZ2VUYWdJZHMoJ2x1eFRhZ0lkJywgbmV3VGFnSWQpO1xuICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lmhhc0F0dHJpYnV0ZShMdXhUYWdJZERpcmVjdGl2ZS5sdXhUYWdJZEF0dHJOYW1lKSkge1xuICAgICAgICBuZXdUYWdJZCA9IHRoaXMubWVyZ2VUYWdJZHMoZWxlbWVudC5nZXRBdHRyaWJ1dGUoTHV4VGFnSWREaXJlY3RpdmUubHV4VGFnSWRBdHRyTmFtZSksIG5ld1RhZ0lkKTtcbiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5oYXNBdHRyaWJ1dGUoJ2x1eGNvbnRyb2xiaW5kaW5nJykpIHtcbiAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdsdXhjb250cm9sYmluZGluZycpLCBuZXdUYWdJZCk7XG4gICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaGFzQXR0cmlidXRlKCdmb3JtZ3JvdXBuYW1lJykpIHtcbiAgICAgICAgbmV3VGFnSWQgPSB0aGlzLm1lcmdlVGFnSWRzKFxuICAgICAgICAgICdmb3JtZ3JvdXAnICsgTHV4VGFnSWREaXJlY3RpdmUuc2VwQ29tcG9uZW50ICsgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2Zvcm1ncm91cG5hbWUnKSxcbiAgICAgICAgICBuZXdUYWdJZFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5nZXRMdXhUYWdJZFBhcmVudChlbGVtZW50LnBhcmVudEVsZW1lbnQsIG5ld1RhZ0lkKTtcbiAgICB9XG5cbiAgICByZXR1cm4gY3VycmVudFRhZ0lkO1xuICB9XG5cbiAgcHJpdmF0ZSBtZXJnZVRhZ0lkcyh0YWdJZDE6IHN0cmluZywgdGFnSWQyOiBzdHJpbmcpIHtcbiAgICBsZXQgdGFnSWQ6IHN0cmluZztcblxuICAgIGlmICghTHV4VXRpbC5pc0VtcHR5KHRhZ0lkMSkgJiYgIUx1eFV0aWwuaXNFbXB0eSh0YWdJZDIpKSB7XG4gICAgICB0YWdJZCA9IHRhZ0lkMSArIEx1eFRhZ0lkRGlyZWN0aXZlLnNlcFBhcmVudCArIHRhZ0lkMjtcbiAgICB9IGVsc2UgaWYgKCFMdXhVdGlsLmlzRW1wdHkodGFnSWQxKSAmJiBMdXhVdGlsLmlzRW1wdHkodGFnSWQyKSkge1xuICAgICAgdGFnSWQgPSB0YWdJZDE7XG4gICAgfSBlbHNlIGlmIChMdXhVdGlsLmlzRW1wdHkodGFnSWQxKSAmJiAhTHV4VXRpbC5pc0VtcHR5KHRhZ0lkMikpIHtcbiAgICAgIHRhZ0lkID0gdGFnSWQyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0YWdJZCA9ICcnO1xuICAgIH1cblxuICAgIHJldHVybiB0YWdJZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0THV4VGFnSWQoZWxlbWVudDogRWxlbWVudCk6IHN0cmluZyB7XG4gICAgbGV0IG5ld0lkID0gJyc7XG5cbiAgICBpZiAoZWxlbWVudCkge1xuICAgICAgaWYgKGVsZW1lbnQuaGFzQXR0cmlidXRlKCdsdXhUYWdJZCcpKSB7XG4gICAgICAgIG5ld0lkID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2x1eFRhZ0lkJyk7XG4gICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaGFzQXR0cmlidXRlKEx1eFRhZ0lkRGlyZWN0aXZlLmx1eFRhZ0lkQXR0ck5hbWUpKSB7XG4gICAgICAgIG5ld0lkID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoTHV4VGFnSWREaXJlY3RpdmUubHV4VGFnSWRBdHRyTmFtZSk7XG4gICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaGFzQXR0cmlidXRlKCdsdXhjb250cm9sYmluZGluZycpKSB7XG4gICAgICAgIG5ld0lkID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2x1eGNvbnRyb2xiaW5kaW5nJyk7XG4gICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaGFzQXR0cmlidXRlKCdmb3JtZ3JvdXBuYW1lJykpIHtcbiAgICAgICAgbmV3SWQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgnZm9ybWdyb3VwbmFtZScpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXdJZDtcbiAgfVxuXG4gIHByaXZhdGUgZmluZEx1eENvbXBvbmVudChlbGVtZW50OiBFbGVtZW50KTogRWxlbWVudCB7XG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIGNvbnN0IG5vZGVOYW1lOiBzdHJpbmcgPSB0aGlzLmdldE5vZGVOYW1lKGVsZW1lbnQpO1xuICAgICAgaWYgKG5vZGVOYW1lICYmIG5vZGVOYW1lLnN0YXJ0c1dpdGgoJ2x1eC0nLnRvVXBwZXJDYXNlKCkpICYmIG5vZGVOYW1lICE9PSBsdXhGb3JtQ29udHJvbFNlbGVrdG9yLnRvVXBwZXJDYXNlKCkpIHtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQ7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5maW5kTHV4Q29tcG9uZW50KGVsZW1lbnQucGFyZW50RWxlbWVudCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBwcml2YXRlIGdldE5vZGVOYW1lKGVsZW1lbnQ6IEVsZW1lbnQpOiBzdHJpbmcge1xuICAgIHJldHVybiBlbGVtZW50ICYmIGVsZW1lbnQubm9kZU5hbWUgPyBlbGVtZW50Lm5vZGVOYW1lIDogJyc7XG4gIH1cbn1cbiJdfQ==